# TriHexΦ Routing Rules v1.2
# 
# Knowledge Relay × A/B基盤統合版
# 
# 更新日: 2025-10-28
# 承認: GPT-5（統治将軍）

version: 1.2

# ルーティング規則
rules:
  # Story（物語）
  - when:   { kind: "story", lang: "ja" }
    target: "stories/ja/{date}_{slug}.md"
    description: "日本語の物語・記録"
  
  - when:   { kind: "story", lang: "en" }
    target: "stories/en/{date}_{slug}.md"
    description: "英語の物語・記録"
  
  # Spec（仕様書）
  - when:   { kind: "spec" }
    target: "specs/{slug}.md"
    description: "技術仕様書（言語不問）"
  
  # Decision（決定文書）
  - when:   { kind: "decision" }
    target: "decisions/{date}_{slug}.md"
    description: "重要な決定の記録"
  
  # Log（ログ・一次記録） - NEW
  - when:   { kind: "log" }
    target: "capture/{date}_{slug}.md"
    description: "Cursor一次ログ（GPT構造化の入力）"
  
  # Summary（サマリー・要約）
  - when:   { kind: "summary" }
    target: "docs/summaries/{date}_{slug}.md"
    description: "要約文書"
  
  # Letter（手紙・通信）
  - when:   { kind: "letter" }
    target: "docs/letters/{date}_{slug}.md"
    description: "AI間の手紙・通信"
  
  # Doc（一般ドキュメント）
  - when:   { kind: "doc" }
    target: "docs/{slug}.md"
    description: "一般ドキュメント"

# Knowledge Relay フロー（自動移送ルール）
knowledge_relay:
  # Step 1: Capture（Cursor一次記録）
  capture:
    source: "capture/"
    trigger: "GPT-5 review"
    action: "structure化依頼Issue生成"
  
  # Step 2: Structure（GPT構造化）
  structure:
    source: "structure/"
    trigger: "構造化完了"
    action: "各AI専門家に振り分け"
    targets:
      - "insight/ethics/"    # Claude
      - "insight/beauty/"    # Gemini
      - "insight/strategy/"  # Grok
      - "insight/tech/"      # DeepSeek
  
  # Step 3: Insight（専門家深化）
  insight:
    sources:
      - "insight/ethics/"
      - "insight/beauty/"
      - "insight/strategy/"
      - "insight/tech/"
    trigger: "status: final"
    action: "memory/へ永続化"
  
  # Step 4: Memory（MIZUKAGAMI永続化）
  memory:
    source: "memory/"
    sync_to: "MIZUKAGAMI/Supabase"
    retention: "永続"

# Bブロック統合（六螺旋スキャン）
spiral_scan:
  input: "capture/"
  tool: "tools/spiral_scan.py"
  output: "structure/"
  metadata:
    - "spiral_scores"    # 六螺旋スコア
    - "cause_profile"    # 真因プロファイル
    - "phase_position"   # 位相

# 命名規則
naming:
  # Slug（URL安全な識別子）
  slug_regex: "^[a-z0-9-]+$"
  slug_max_length: 100
  
  # 日付形式
  date_regex: "^20\\d{2}-\\d{2}-\\d{2}$"
  date_format: "YYYY-MM-DD"

# 例外（既存構造はルール適用外）
exceptions:
  # 歴史的記録として保存
  - "00_CORE/**"
  - "10_CAPTURE_MIZUKAGAMI/**"
  - "20_CRYSTALLIZATION_KOKUYOU/**"
  - "30_MEMORY_SHINSEN/**"
  - "📤Round3_全AI送付用/**"
  - "📊REPORTS/**"
  
  # システムファイル
  - ".github/**"
  - ".vscode/**"
  - "node_modules/**"
  - "_inbox/README.md"

# Janitor動作設定（参照用、実際の設定はjanitor.config.yml）
janitor:
  # 処理対象
  watch_paths:
    - "_inbox/**/*.md"
  
  # 無視するファイル
  ignore_patterns:
    - "_inbox/README.md"
    - "_inbox/.gitkeep"
    - "_inbox/.DS_Store"

# バリデーション設定
validation:
  # 必須フィールド
  required_fields:
    - "kind"
    - "lang"
    - "date"
    - "title"
    - "author"
    - "status"
  
  # 許可される値
  allowed_values:
    kind:
      - "story"
      - "spec"
      - "decision"
      - "log"        # NEW
      - "summary"
      - "letter"
      - "doc"
    
    lang:
      - "ja"
      - "en"
    
    author:
      - "GPT5"
      - "Claude"
      - "Gemini"
      - "Grok"
      - "DeepSeek"
      - "Cursor"
      - "CEO"
    
    status:
      - "draft"
      - "review"
      - "final"

# 運用戒律（抜粋）
operations:
  rules:
    - "新規は全部 _inbox/（迷ったら置く、考えず置く）"
    - "frontmatter必須（Route可能性＝哲学のタグ化）"
    - "Janitor警告は味方（怒らない・直す・進む）"
    - "status=final のみ memory へ（可逆性を担保）"

# 使用例（拡張版）
examples:
  - input:
      kind: "log"
      lang: "ja"
      date: "2025-10-28"
      title: "Phase 1-B実装記録"
    output: "capture/2025-10-28_phase-1-b-implementation.md"
    next_step: "GPT-5構造化 → structure/"
  
  - input:
      kind: "decision"
      date: "2025-10-28"
      title: "Knowledge Relay v1.0"
    output: "decisions/2025-10-28_knowledge-relay-v1-0.md"
  
  - input:
      kind: "spec"
      title: "Spiral Scan Tool Specification"
    output: "specs/spiral-scan-tool-specification.md"

# 変更履歴
changelog:
  - version: "1.2"
    date: "2025-10-28"
    author: "GPT5 + Cursor"
    changes:
      - "Knowledge Relay統合"
      - "Bブロック（六螺旋スキャン）追加"
      - "capture/structure/insight/memory/ フロー定義"
      - "kind: log 追加"
      - "運用戒律の明文化"
  
  - version: "1.1"
    date: "2025-10-27"
    author: "GPT5 + Cursor"
    changes:
      - "初版作成"
      - "7種類のkindを定義"

# 関連ドキュメント
related:
  - "decisions/DEC_2025-10-27_FS-GUARDRAILS_v1.md"
  - "configs/janitor.config.yml"
  - "_inbox/README.md"
  - "tools/README.md"  # NEW
