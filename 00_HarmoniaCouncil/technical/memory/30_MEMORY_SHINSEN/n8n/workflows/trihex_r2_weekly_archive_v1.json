{
  "name": "TRIHEX R2 Weekly Archive v1",
  "nodes": [
    {
      "id": "cron_weekly",
      "name": "Cron (Sun 19:00 UTC)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [260, 300],
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "custom",
              "cronExpression": "0 19 * * 0"
            }
          ]
        }
      }
    },
    {
      "id": "pg_export",
      "name": "Supabase Query (archive read)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [520, 300],
      "credentials": {
        "postgres": {
          "id": "__FILL_ME__",
          "name": "Supabase-Postgres"
        }
      },
      "parameters": {
        "operation": "query",
        "query": "select * from public.memory_events_archive where created_at >= now() - interval '8 days' order by created_at desc limit 500000;"
      }
    },
    {
      "id": "to_csv",
      "name": "Spreadsheet File (CSV)",
      "type": "n8n-nodes-base.spreadsheetFile",
      "typeVersion": 1,
      "position": [760, 300],
      "parameters": {
        "operation": "toFile",
        "fileFormat": "csv",
        "options": {
          "headerRow": true
        }
      }
    },
    {
      "id": "s3_put",
      "name": "R2 Upload (S3 compatible)",
      "type": "n8n-nodes-base.s3",
      "typeVersion": 2,
      "position": [1000, 300],
      "credentials": {
        "s3": {
          "id": "__FILL_ME__",
          "name": "Cloudflare-R2"
        }
      },
      "parameters": {
        "operation": "upload",
        "binaryPropertyName": "data",
        "bucketName": "trihex-archive",
        "fileName": "memory_events_archive/{{$now.format('YYYY')}}/{{$now.format('MM')}}/me_{{$now.format('YYYYMMDD_HHmmss')}}.csv",
        "options": {
          "forcePathStyle": true,
          "endpoint": "https://c4d92c479a309c53bf05082a7e938bd1.r2.cloudflarestorage.com",
          "region": "auto",
          "acl": "private"
        }
      }
    }
  ],
  "connections": {
    "cron_weekly": { "main": [ [ { "node": "Supabase Query (archive read)", "type": "main", "index": 0 } ] ] },
    "Supabase Query (archive read)": { "main": [ [ { "node": "Spreadsheet File (CSV)", "type": "main", "index": 0 } ] ] },
    "Spreadsheet File (CSV)": { "main": [ [ { "node": "R2 Upload (S3 compatible)", "type": "main", "index": 0 } ] ] }
  },
  "active": false
}
