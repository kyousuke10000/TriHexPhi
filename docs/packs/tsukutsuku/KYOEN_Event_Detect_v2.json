{
  "name": "KYOEN Event Detect v2",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "kyoen-line-in",
        "options": {}
      },
      "id": "webhook",
      "name": "LINE Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "kyoen-line-in"
    },
    {
      "parameters": {
        "jsCode": "// ãŠå‰ãŒè§£æ±ºã—ãŸæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼\nconst items = $input.all();\n\nreturn items.map(item => {\n  const webhookData = item.json.body?.events?.[0];\n  \n  return {\n    json: {\n      message: webhookData?.message?.text || '',\n      replyToken: webhookData?.replyToken,\n      groupId: webhookData?.source?.groupId,\n      userId: webhookData?.source?.userId,\n      messageType: webhookData?.message?.type,\n      timestamp: webhookData?.timestamp\n    }\n  };\n});"
      },
      "id": "extract",
      "name": "Extract Webhook Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// æ„å›³åˆ†é¡ï¼ˆè»½é‡ãƒ«ãƒ¼ãƒ«ï¼‰\nconst message = $json.message.toLowerCase();\nlet intent = 'misc';\n\n// ã‚¤ãƒ™ãƒ³ãƒˆæ¤œçŸ¥\nif (message.match(/^\\/event|ã‚¤ãƒ™ãƒ³ãƒˆ:|æ—¥æ™‚:|^\\d{4}-\\d{2}-\\d{2}/)) {\n  intent = 'event';\n// RSVPæ¤œçŸ¥\n} else if (message.match(/å‚åŠ |ä¸å‚åŠ |è¡Œã‘ã¾ã™|è¡Œã‘ãªã„|ãŸã¶ã‚“|æ¤œè¨ä¸­/)) {\n  intent = 'rsvp';\n// ä¼šè­°æ¤œçŸ¥\n} else if (message.match(/^\\/meeting|zoom\\.us|ä¼šè­°:/i)) {\n  intent = 'meeting';\n// ã‚«ãƒ¼ãƒ‰ç”Ÿæˆæ¤œçŸ¥\n} else if (message.match(/^\\/card|å‘ŠçŸ¥|ã‚«ãƒ¼ãƒ‰/)) {\n  intent = 'card';\n// ãƒªãƒ³ã‚¯æ¤œçŸ¥\n} else if (message.match(/^https?:\\/\\//)) {\n  intent = 'link';\n// è³ªå•æ¤œçŸ¥\n} else if (message.match(/\\?$|æ•™ãˆã¦|è³ªå•/)) {\n  intent = 'question';\n// ã‚¿ã‚¹ã‚¯æ¤œçŸ¥\n} else if (message.match(/todo|ã‚¿ã‚¹ã‚¯:|ã‚„ã‚‹ã“ã¨/i)) {\n  intent = 'task';\n}\n\nreturn [{\n  json: {\n    ...$json,\n    intent: intent\n  }\n}];"
      },
      "id": "classify",
      "name": "Classify Intent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://nrbserphtykbhwdowfsz.supabase.co/rest/v1/kyoen_messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yYnNlcnBodHlrYmh3ZG93ZnN6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDQ3MjU3MSwiZXhwIjoyMDc2MDQ4NTcxfQ.RJz5YJ0lmR_raX_glkncd-h_z9r2qRy7yPRUTJz2T90"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yYnNlcnBodHlrYmh3ZG93ZnN6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDQ3MjU3MSwiZXhwIjoyMDc2MDQ4NTcxfQ.RJz5YJ0lmR_raX_glkncd-h_z9r2qRy7yPRUTJz2T90"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"line_group_id\": $json.groupId || \"direct\",\n  \"line_user_id\": $json.userId,\n  \"text\": $json.message,\n  \"intent\": $json.intent,\n  \"meta\": {\n    \"timestamp\": $json.timestamp,\n    \"messageType\": $json.messageType\n  }\n} }}",
        "options": {}
      },
      "id": "save",
      "name": "Save to Supabase",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "// å³åº§ã«è»½ã„è¿”ä¿¡ï¼ˆreplyTokenå¤±åŠ¹å¯¾ç­–ï¼‰\nconst intent = $json.intent;\nlet replyText = '';\n\nswitch(intent) {\n  case 'event':\n    replyText = 'ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’ç¢ºèªä¸­ã§ã™ã€‚è©³ç´°ã¯å¾Œã»ã©é€ã‚Šã¾ã™ã€‚';\n    break;\n  case 'rsvp':\n    replyText = 'âœ… å‚åŠ çŠ¶æ³ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚';\n    break;\n  case 'meeting':\n    replyText = 'ğŸ¥ ä¼šè­°æƒ…å ±ã‚’å‡¦ç†ä¸­ã§ã™ã€‚';\n    break;\n  case 'card':\n    replyText = 'ğŸ¨ ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚';\n    break;\n  case 'question':\n    replyText = 'ğŸ’¬ å›ç­”ã‚’æº–å‚™ä¸­ã§ã™...';\n    break;\n  case 'task':\n    replyText = 'ğŸ“ ã‚¿ã‚¹ã‚¯ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚';\n    break;\n  case 'link':\n    replyText = 'ğŸ”— ãƒªãƒ³ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚';\n    break;\n  default:\n    replyText = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚';\n}\n\nreturn [{\n  json: {\n    replyToken: $json.replyToken,\n    messages: [{\n      type: 'text',\n      text: replyText\n    }]\n  }\n}];"
      },
      "id": "quick-reply",
      "name": "Quick Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "send-quick",
      "name": "Send Quick Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 300],
      "credentials": {
        "httpBearerAuth": {
          "id": "QRKJXPGqYDBafpzN",
          "name": "LINE"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.intent }}",
              "operation": "equals",
              "value2": "event"
            }
          ]
        }
      },
      "id": "route-event",
      "name": "Route: Event?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1120, 500]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.intent }}",
              "operation": "equals",
              "value2": "question"
            }
          ]
        }
      },
      "id": "route-question",
      "name": "Route: Question?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1120, 700]
    },
    {
      "parameters": {
        "jsCode": "// ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®æŠ½å‡º\nconst message = $json.message;\n\n// æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³\nconst dateMatch1 = message.match(/(\\d{4})-(\\d{2})-(\\d{2})/);\nconst dateMatch2 = message.match(/(\\d{1,2})\\/(\\d{1,2})/);\nconst timeMatch = message.match(/(\\d{1,2}):(\\d{2})(?:\\s*-\\s*(\\d{1,2}):(\\d{2}))?/);\nconst zoomMatch = message.match(/(https?:\\/\\/(?:[^\\s]+)?zoom\\.us\\/[^\\s?]+\\?pwd=[^\\s]+)/);\n\nlet dateStr = null;\nif (dateMatch1) {\n  dateStr = `${dateMatch1[1]}-${dateMatch1[2]}-${dateMatch1[3]}`;\n} else if (dateMatch2) {\n  const year = new Date().getFullYear();\n  dateStr = `${year}-${dateMatch2[1].padStart(2, '0')}-${dateMatch2[2].padStart(2, '0')}`;\n}\n\nlet timeStr = '00:00';\nif (timeMatch) {\n  timeStr = `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}`;\n}\n\nconst title = message.split('\\n')[0].trim();\nconst zoomUrl = zoomMatch ? zoomMatch[0] : null;\nconst startAt = dateStr ? `${dateStr}T${timeStr}:00+09:00` : null;\n\n// å ´æ‰€ã®æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰\nconst locationMatch = message.match(/å ´æ‰€[:ï¼š]\\s*(.+)/i);\nconst location = locationMatch ? locationMatch[1].trim() : null;\n\nreturn [{\n  json: {\n    title,\n    start_at: startAt,\n    zoom_url: zoomUrl,\n    location,\n    userId: $json.userId,\n    groupId: $json.groupId\n  }\n}];"
      },
      "id": "parse-event",
      "name": "Parse Event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 420]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://nrbserphtykbhwdowfsz.supabase.co/rest/v1/tokunoshima_events",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yYnNlcnBodHlrYmh3ZG93ZnN6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDQ3MjU3MSwiZXhwIjoyMDc2MDQ4NTcxfQ.RJz5YJ0lmR_raX_glkncd-h_z9r2qRy7yPRUTJz2T90"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yYnNlcnBodHlrYmh3ZG93ZnN6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDQ3MjU3MSwiZXhwIjoyMDc2MDQ4NTcxfQ.RJz5YJ0lmR_raX_glkncd-h_z9r2qRy7yPRUTJz2T90"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"title\": $json.title,\n  \"start_at\": $json.start_at,\n  \"zoom_url\": $json.zoom_url,\n  \"location\": $json.location,\n  \"created_by\": \"tokunoshima\"\n} }}",
        "options": {}
      },
      "id": "upsert-event",
      "name": "Upsert Event",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1560, 420]
    },
    {
      "parameters": {
        "jsCode": "// Flex Message for Eventï¼ˆPushç”¨ï¼‰\nconst event = $json[0];\nconst userId = $('Parse Event').item.json.userId;\nconst groupId = $('Parse Event').item.json.groupId;\n\nconst flexMessage = {\n  type: 'flex',\n  altText: event.title || 'ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±',\n  contents: {\n    type: 'bubble',\n    header: {\n      type: 'box',\n      layout: 'vertical',\n      contents: [\n        {\n          type: 'text',\n          text: event.title || 'ç„¡é¡Œ',\n          weight: 'bold',\n          size: 'xl',\n          color: '#ffffff'\n        }\n      ],\n      backgroundColor: '#0367D3'\n    },\n    body: {\n      type: 'box',\n      layout: 'vertical',\n      contents: [\n        {\n          type: 'text',\n          text: 'ğŸ“… æ—¥æ™‚',\n          size: 'sm',\n          color: '#999999'\n        },\n        {\n          type: 'text',\n          text: event.start_at || 'æ—¥æ™‚æœªå®š',\n          size: 'md',\n          weight: 'bold'\n        },\n        {\n          type: 'text',\n          text: 'ğŸ“ å ´æ‰€',\n          size: 'sm',\n          color: '#999999',\n          margin: 'md'\n        },\n        {\n          type: 'text',\n          text: event.location || 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³',\n          size: 'md'\n        }\n      ]\n    },\n    footer: {\n      type: 'box',\n      layout: 'horizontal',\n      spacing: 'sm',\n      contents: [\n        {\n          type: 'button',\n          style: 'primary',\n          action: {\n            type: 'postback',\n            data: `rsvp:yes:${event.id}`,\n            label: 'å‚åŠ ã™ã‚‹',\n            displayText: 'å‚åŠ ã—ã¾ã™'\n          }\n        },\n        {\n          type: 'button',\n          style: 'secondary',\n          action: {\n            type: 'postback',\n            data: `rsvp:maybe:${event.id}`,\n            label: 'æ¤œè¨ä¸­',\n            displayText: 'æ¤œè¨ä¸­ã§ã™'\n          }\n        },\n        {\n          type: 'button',\n          action: {\n            type: 'postback',\n            data: `rsvp:no:${event.id}`,\n            label: 'ä¸å‚åŠ ',\n            displayText: 'ä¸å‚åŠ ã§ã™'\n          }\n        }\n      ]\n    }\n  }\n};\n\nreturn [{\n  json: {\n    to: groupId || userId,\n    messages: [flexMessage]\n  }\n}];"
      },
      "id": "build-flex",
      "name": "Build Flex Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 420]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/push",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "push-flex",
      "name": "Push Flex Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 420],
      "credentials": {
        "httpBearerAuth": {
          "id": "QRKJXPGqYDBafpzN",
          "name": "LINE"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message }}",
        "options": {
          "systemMessage": "ã‚ãªãŸã¯LINEãƒãƒ£ãƒ³ãƒãƒ«ã®ç®¡ç†è€…ã§ã™ã€‚USERã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«é©åˆ‡ã«ç­”ãˆã¦ãã ã•ã„ã€‚ç°¡æ½”ã«ã€åˆ†ã‹ã‚Šã‚„ã™ãå›ç­”ã—ã¦ãã ã•ã„ã€‚"
        }
      },
      "id": "ai-agent",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [1340, 700]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "id": "openai-model",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [1340, 840],
      "credentials": {
        "openAiApi": {
          "id": "aUn4Ie0YXl6SXecB",
          "name": "KYOEN AI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// AIå›ç­”ã‚’Push Messageç”¨ã«æ§‹ç¯‰\nconst aiResponse = $json.output || $json.text || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“';\nconst userId = $('Classify Intent').item.json.userId;\nconst groupId = $('Classify Intent').item.json.groupId;\n\nreturn [{\n  json: {\n    to: groupId || userId,\n    messages: [{\n      type: 'text',\n      text: aiResponse\n    }]\n  }\n}];"
      },
      "id": "build-ai-reply",
      "name": "Build AI Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 700]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/push",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "push-ai",
      "name": "Push AI Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1780, 700],
      "credentials": {
        "httpBearerAuth": {
          "id": "QRKJXPGqYDBafpzN",
          "name": "LINE"
        }
      }
    }
  ],
  "connections": {
    "LINE Webhook": {
      "main": [
        [
          {
            "node": "Extract Webhook Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Webhook Data": {
      "main": [
        [
          {
            "node": "Classify Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classify Intent": {
      "main": [
        [
          {
            "node": "Save to Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Supabase": {
      "main": [
        [
          {
            "node": "Quick Reply",
            "type": "main",
            "index": 0
          },
          {
            "node": "Route: Event?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Route: Question?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Quick Reply": {
      "main": [
        [
          {
            "node": "Send Quick Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route: Event?": {
      "main": [
        [
          {
            "node": "Parse Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route: Question?": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Event": {
      "main": [
        [
          {
            "node": "Upsert Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Event": {
      "main": [
        [
          {
            "node": "Build Flex Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Flex Message": {
      "main": [
        [
          {
            "node": "Push Flex Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Build AI Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Reply": {
      "main": [
        [
          {
            "node": "Push AI Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "saveManualExecutions": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "bb6582f136488f8663186c75084ae9be2ac2ce1a6068064fd0778c5e05f7b8d2"
  },
  "tags": []
}
