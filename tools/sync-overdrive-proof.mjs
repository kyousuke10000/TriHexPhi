#!/usr/bin/env node
/**
 * Sync AI Overdrive logs from Supabase to Proofs
 */

import { execSync } from 'node:child_process';
import fs from 'node:fs/promises';
import path from 'node:path';

const sh = (cmd, opts = {}) => {
  try {
    const out = execSync(cmd, { stdio: ['ignore', 'pipe', 'pipe'], ...opts });
    return out.toString().trim();
  } catch (e) {
    const msg = e.stderr?.toString() || e.message;
    throw new Error(`CMD FAIL: ${cmd}\n${msg}`);
  }
};

async function fetchOverdriveLogs() {
  // Supabaseã‹ã‚‰æœ€æ–°10ä»¶ã‚’å–å¾—ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼‰
  // ã“ã“ã§ã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ§‹é€ ã‚’ç¤ºã™
  const supabaseUrl = process.env.SUPABASE_URL || '';
  const supabaseKey = process.env.SUPABASE_ANON_KEY || '';
  
  if (!supabaseUrl || !supabaseKey) {
    console.log('âš ï¸ Supabase credentials not set. Using mock data.');
    return [];
  }

  try {
    // å®Ÿéš›ã®Supabaseã‚¯ã‚¨ãƒªï¼ˆfetchã‚’ä½¿ç”¨ï¼‰
    const response = await fetch(
      `${supabaseUrl}/rest/v1/ai_overdrive_logs?select=*&order=timestamp.desc&limit=10`,
      {
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${supabaseKey}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    if (!response.ok) {
      throw new Error(`Supabase fetch failed: ${response.statusText}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('Error fetching from Supabase:', error.message);
    return [];
  }
}

function generateProofMarkdown(log) {
  const timestamp = new Date(log.timestamp).toISOString().replace(/[:.]/g, '-');
  const generated = typeof log.generated_content === 'string' 
    ? JSON.parse(log.generated_content) 
    : log.generated_content;
  
  return `# AI Overdrive Proof - ${timestamp}

**Generated**: ${new Date(log.timestamp).toISOString()}
**User ID**: ${log.user_id}

## Original Input

${log.original_text}

## Generated Content

### X Post
\`\`\`
${generated.x_post || 'N/A'}
\`\`\`

### Instagram Caption
\`\`\`
${generated.instagram_caption || 'N/A'}
\`\`\`

### Blog Text
\`\`\`
${generated.blog_text || 'N/A'}
\`\`\`

### Note Text
\`\`\`
${generated.note_text || 'N/A'}
\`\`\`

## Status

${log.status || 'processed'}

---
*Generated by AI Overdrive Sync*
`;
}

async function main() {
  console.log('ğŸ“¥ Fetching AI Overdrive logs from Supabase...');
  const logs = await fetchOverdriveLogs();
  
  if (logs.length === 0) {
    console.log('â„¹ï¸ No logs found. Skipping proof generation.');
    return;
  }
  
  console.log(`âœ… Found ${logs.length} logs`);
  
  const proofsDir = '99_SYSTEM/Proofs';
  await fs.mkdir(proofsDir, { recursive: true });
  
  // æœ€æ–°10ä»¶ã‚’Proofã¨ã—ã¦ä¿å­˜
  for (const log of logs.slice(0, 10)) {
    const timestamp = new Date(log.timestamp).toISOString().replace(/[:.]/g, '-');
    const filename = `Overdrive_${timestamp}.md`;
    const filepath = path.join(proofsDir, filename);
    
    const content = generateProofMarkdown(log);
    await fs.writeFile(filepath, content, 'utf8');
    console.log(`âœ… Generated: ${filename}`);
  }
  
  // index.mdã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®generate-public-index.mjsã‚’å†åˆ©ç”¨ï¼‰
  try {
    sh('node scripts/generate-public-index.mjs index.md');
    console.log('âœ… Updated index.md');
  } catch (error) {
    console.log('âš ï¸ Failed to update index.md:', error.message);
  }
}

main().catch(error => {
  console.error('âŒ Error:', error.message);
  process.exit(1);
});

