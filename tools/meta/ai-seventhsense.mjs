#!/usr/bin/env node
// tools/meta/ai-meta.mjs
import fs from "fs";
import path from "path";
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// アダプタのインポート
import { askGemini } from "./adapters/gemini.mjs";
import { askGPT } from "./adapters/gpt.mjs";
import { askClaude } from "./adapters/claude.mjs";
import { askDeepSeek } from "./adapters/deepseek.mjs";
import { askGrok } from "./adapters/grok.mjs";
import { askPerplexity } from "./adapters/perplexity.mjs";

import { scoreCandidates } from "./policies/fusion.mjs";

function loadIntent() {
  let intent = "";
  
  // STRUCTURE_MASTER.yml を読み込み
  const smPath = "00_HarmoniaCouncil/STRUCTURE_MASTER.yml";
  if (fs.existsSync(smPath)) {
    try {
      intent += fs.readFileSync(smPath, "utf8");
    } catch (e) {
      console.warn("⚠️ Could not read STRUCTURE_MASTER.yml:", e.message);
    }
  }
  
  // Council Decisions を読み込み
  const decsPath = "00_RYUDO/Council/Decisions";
  if (fs.existsSync(decsPath)) {
    try {
      const decs = fs.readdirSync(decsPath)
        .filter(f => f.endsWith(".md"))
        .slice(-10)
        .map(f => fs.readFileSync(path.join(decsPath, f), "utf8"))
        .join("\n\n");
      intent += "\n\n" + decs;
    } catch (e) {
      console.warn("⚠️ Could not read Council Decisions:", e.message);
    }
  }
  
  return intent || "No intent documents found";
}

export async function metaAsk({userPrompt, systemHint = ""}) {
  const intent = loadIntent();
  const systemPrompt = systemHint || intent;

  console.log(`[SeventhSense] Querying ${userPrompt.slice(0, 50)}...`);
  console.log(`[SeventhSense] Intent loaded: ${intent.length} chars`);

  // 各AIを並列実行（Promise.allSettledで失敗を許容）
  const calls = [
    askGemini({ prompt: userPrompt, system: systemPrompt }).catch(e => ({ error: e.message, model: "gemini" })),
    askGPT({ prompt: userPrompt, system: systemPrompt }).catch(e => ({ error: e.message, model: "gpt" })),
    askClaude({ prompt: userPrompt, system: systemPrompt }).catch(e => ({ error: e.message, model: "claude" })),
    askDeepSeek({ prompt: userPrompt, system: systemPrompt }).catch(e => ({ error: e.message, model: "deepseek" })),
    askGrok({ prompt: userPrompt, system: systemPrompt }).catch(e => ({ error: e.message, model: "grok" })),
    askPerplexity({ prompt: userPrompt, system: systemPrompt }).catch(e => ({ error: e.message, model: "perplexity" })),
  ];

  const results = await Promise.allSettled(calls);
  
  // 成功した結果のみをフィルタ
  const cands = results
    .filter(r => r.status === "fulfilled" && !r.value.error)
    .map(r => r.value);
  
  // エラーをログ出力
  results.forEach((r, i) => {
    if (r.status === "rejected" || (r.value && r.value.error)) {
      const model = ["gemini", "gpt", "claude", "deepseek", "grok", "perplexity"][i];
      console.warn(`⚠️ ${model} failed:`, r.status === "rejected" ? r.reason : r.value.error);
    }
  });

  if (cands.length === 0) {
    throw new Error("All AI adapters failed");
  }

  console.log(`[SeventhSense] ${cands.length} candidates received`);

  // スコアリング
  const ranked = scoreCandidates({ cands, intentDoc: intent, evidenceHints: [] });

  const best = ranked[0] || { answer: "<no candidate>", fusion_score: 0, model: "none" };
  
  console.log(`[SeventhSense] Best: ${best.model} (score=${best.fusion_score})`);

  // Proof生成
  const proof = {
    generated_at: new Date().toISOString(),
    prompt: userPrompt,
    system_hint: systemHint || "STRUCTURE_MASTER",
    candidates: ranked.map(c => ({
      model: c.model,
      score: c.fusion_score,
      answer_preview: c.answer.slice(0, 100) + "..."
    })),
    chosen: {
      model: best.model,
      score: best.fusion_score,
      answer: best.answer
    },
    intent_length: intent.length,
    candidates_count: ranked.length
  };

  // Proofs/SeventhSense に保存
  const dir = "99_SYSTEM/Proofs/SeventhSense";
  fs.mkdirSync(dir, { recursive: true });
  const ts = Date.now();
  
  fs.writeFileSync(
    `${dir}/SEVENTHSENSE_${ts}.json`,
    JSON.stringify(proof, null, 2)
  );
  
  fs.writeFileSync(
    `${dir}/SEVENTHSENSE_${ts}.md`,
    `# SeventhSense Fusion Result

**Time**: ${new Date(ts).toISOString()}
**Prompt**: ${userPrompt}
**Chosen**: ${best.model} (score=${best.fusion_score})
**Candidates**: ${ranked.length}

## Final Answer

${best.answer}

## Models Scored

${ranked.map(c => `- **${c.model}**: ${c.fusion_score} - ${c.answer.slice(0, 80)}...`).join("\n")}

## Intent Context

Intent document length: ${intent.length} chars

---
*Generated by SeventhSense (7th AI) Fusion System*
`
  );

  console.log(`✅ Proof saved: ${dir}/SEVENTHSENSE_${ts}.md`);

  return best.answer;
}

// CLI実行時の処理
if (import.meta.url === `file://${process.argv[1]}` || process.argv[1]?.endsWith('ai-meta.mjs')) {
  const q = process.argv.slice(2).join(" ").trim() || "AI OverdriveのLPの最短構成案を出して";
  const systemArg = process.argv.indexOf('--system');
  const systemHint = systemArg >= 0 && process.argv[systemArg + 1] ? process.argv[systemArg + 1] : "";
  
  metaAsk({ userPrompt: q, systemHint })
    .then(a => {
      console.log("\n=== SeventhSense Answer ===\n");
      console.log(a);
      console.log("\n=====================\n");
    })
    .catch(e => {
      console.error("❌ Error:", e.message);
      process.exit(1);
    });
}

