{
  "name": "ğŸ¤– Chatwork FAQ Collector (Phase 3.4)",
  "nodes": [
    {
      "parameters": {},
      "id": "6f119d41-2648-4d0f-98d5-a225cf7c77e7",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1696,
        752
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1SywiLtNP759TQ_dWnYq1XftGTJprZOL9kVx5dlLiH_0"
        },
        "sheetName": {
          "__rl": true,
          "value": 1277927532,
          "mode": "list",
          "cachedResultName": "Ritual_Log"
        },
        "options": {}
      },
      "id": "6a356606-8c9a-4cf9-af6c-7226271ff26f",
      "name": "Get Ritual_Log",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -1488,
        752
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YvL7P7HKwcuiK11r",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "dateTime": [
            {
              "value1": "={{ $json.timestamp }}",
              "operation": "afterDate",
              "value2": "={{ $now.minus(30, 'days').toISO() }}"
            }
          ]
        },
        "options": {}
      },
      "id": "3183450a-fff9-4984-8a33-b27d4d8618ba",
      "name": "Filter Last 30 Days",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        -1296,
        752
      ]
    },
    {
      "parameters": {
        "sortFieldsUi": {
          "sortField": [
            {
              "fieldName": "timestamp",
              "order": "descending"
            }
          ]
        },
        "options": {}
      },
      "id": "2d9eb9ce-0a72-4a22-8ea0-605707b6a558",
      "name": "Sort by Timestamp DESC",
      "type": "n8n-nodes-base.sort",
      "typeVersion": 1,
      "position": [
        -1088,
        752
      ]
    },
    {
      "parameters": {},
      "id": "b8803e32-e591-4419-bc89-ebb594102980",
      "name": "Get Latest Entry",
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        -896,
        752
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ Object.keys($json).length }}",
                    "rightValue": 0,
                    "operator": {
                      "type": "number",
                      "operation": "gt"
                    },
                    "id": "82989eec-4788-41e0-8881-bd235b53fe1d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Has Data"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "e91d53dd-5ba4-476e-bada-aa6e9044c9f3",
      "name": "Has Recent Promotion?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -688,
        752
      ]
    },
    {
      "parameters": {},
      "id": "a009334f-300d-4f48-a78c-059da6f61f75",
      "name": "No Recent Promotion",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -288,
        848
      ]
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://discord.com/api/v10/guilds/1423868161110835202/members/{{ $json.user_id }}/roles/{{ $json.to_role_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "options": {}
      },
      "id": "0ea87f2f-be01-4eb3-b06b-02c96a0a158b",
      "name": "Remove Discord Role",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -288,
        656
      ],
      "credentials": {
        "discordBotApi": {
          "id": "OsNxV1rUyzVam6wZ",
          "name": "Discord Bot account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1SywiLtNP759TQ_dWnYq1XftGTJprZOL9kVx5dlLiH_0"
        },
        "sheetName": {
          "__rl": true,
          "value": 1256375429,
          "mode": "list",
          "cachedResultName": "User_Progress"
        },
        "options": {}
      },
      "id": "b1ce67ef-05ac-42a8-95a4-573f858db383",
      "name": "Get User_Progress",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        544,
        656
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YvL7P7HKwcuiK11r",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1SywiLtNP759TQ_dWnYq1XftGTJprZOL9kVx5dlLiH_0"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 1256375429,
          "cachedResultName": "User_Progress"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $('Get Latest Entry').first().json.user_id }}",
            "current_role": "={{ $('Get Latest Entry').first().json.from_role }}",
            "promotion_needed": "FALSE"
          },
          "matchingColumns": [
            "user_id"
          ],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "current_role",
              "displayName": "current_role",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "spiral_score",
              "displayName": "spiral_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "window_start",
              "displayName": "window_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "window_end",
              "displayName": "window_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "cadence",
              "displayName": "cadence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "depth_mid_pct",
              "displayName": "depth_mid_pct",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "depth_deep_pct",
              "displayName": "depth_deep_pct",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "momentum_count",
              "displayName": "momentum_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "creation_count",
              "displayName": "creation_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ebb_state",
              "displayName": "ebb_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_active",
              "displayName": "last_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "promotion_needed",
              "displayName": "promotion_needed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "next_role",
              "displayName": "next_role",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "resonance_score",
              "displayName": "resonance_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "resonance_partners",
              "displayName": "resonance_partners",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "coherence_score",
              "displayName": "coherence_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "guided_users",
              "displayName": "guided_users",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "e3f80846-4408-4a7e-9db5-1a65f3c1ac5b",
      "name": "Update User_Progress",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        752,
        656
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YvL7P7HKwcuiK11r",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1SywiLtNP759TQ_dWnYq1XftGTJprZOL9kVx5dlLiH_0"
        },
        "sheetName": {
          "__rl": true,
          "value": 1277927532,
          "mode": "list",
          "cachedResultName": "Ritual_Log",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1SywiLtNP759TQ_dWnYq1XftGTJprZOL9kVx5dlLiH_0/edit#gid=1277927532"
        },
        "startIndex": "={{ $('Get Latest Entry').first().json.row_number }}"
      },
      "id": "a96b78fc-3b70-4a89-8701-6b9a11f86025",
      "name": "Delete Ritual_Log Row",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        944,
        656
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YvL7P7HKwcuiK11r",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "mode": "list",
          "value": "1423868161110835202"
        },
        "channelId": {
          "__rl": true,
          "mode": "id",
          "value": "1424549853375234118"
        },
        "content": "=ğŸ”„ [ROLLBACK] æ˜‡æ ¼ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ\n\nUser: {{ $('Get Latest Entry').first().json.username }}\nFrom: {{ $('Get Latest Entry').first().json.to_role }} â†’ {{ $('Get Latest Entry').first().json.from_role }}\nTimestamp: {{ $now.toFormat('yyyy-MM-dd HH:mm:ss') }}",
        "options": {}
      },
      "id": "a8cdcc47-50c5-4d93-8980-e337e4143085",
      "name": "Post Rollback Notice",
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        1136,
        656
      ],
      "webhookId": "ee686f71-7557-42a1-9fdf-c8dc52a39b8b",
      "credentials": {
        "discordBotApi": {
          "id": "OsNxV1rUyzVam6wZ",
          "name": "Discord Bot account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const ROLES = {\n  'creator': '1424198712678154280',\n  'builder': '1424199716333158510',\n  'starter': '1424199864069263560'\n};\n\nconst toRole = $json.to_role;\nconst toRoleId = ROLES[toRole];\n\nreturn {\n  json: {\n    ...$json,\n    to_role_id: toRoleId\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        656
      ],
      "id": "126b1fff-7efc-4c33-befd-81593773fb5c",
      "name": "Convert Role to ID"
    },
    {
      "parameters": {
        "jsCode": "// Get Latest Entry ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—\nconst latestEntry = $('Get Latest Entry').first().json;\n\nconst THREAD_TEMPLATES = {\n  'starter': 'ğŸ’  @{username} ã®æ°´é¡ä¿®è¡Œ',\n  'builder': 'ğŸŒŠ @{username} ã®æ³¢ç´‹ä¿®è¡Œ',\n  'creator': 'ğŸ”® @{username} ã®çœŸå½¢å‰µé€ '\n};\n\nconst fromRole = latestEntry.from_role;\nconst username = latestEntry.username;\n\n// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š\nconst template = THREAD_TEMPLATES[fromRole] || 'ğŸ’  @{username} ã®æ°´é¡ä¿®è¡Œ';\nconst newThreadName = template.replace('{username}', username);\n\nreturn {\n  json: {\n    ...latestEntry,  // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã\n    new_thread_name: newThreadName\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        656
      ],
      "id": "315d6133-56e5-462c-b9a6-57df282b3a6d",
      "name": "Build Thread Name"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://discord.com/api/v10/channels/{{ $json.thread_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"={{ $json.new_thread_name }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        128,
        656
      ],
      "id": "be5ab7f9-8fcd-4d64-85fe-76c71a56a368",
      "name": "Rename Thread",
      "credentials": {
        "discordBotApi": {
          "id": "OsNxV1rUyzVam6wZ",
          "name": "Discord Bot account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 2 * * *"
            }
          ]
        }
      },
      "id": "5cd55f5b-d55d-4152-9944-8d58b7d8a1ab",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1856,
        1424
      ]
    },
    {
      "parameters": {
        "url": "https://api.chatwork.com/v2/rooms/382546940/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "force",
              "value": "1"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "0d4bbc89-7fdd-4b70-82c5-3a211ae7f280",
      "name": "Chatwork Get Messages",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1648,
        1424
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "LnQfObJY55JQWAHf",
          "name": "ChatWork"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Chatwork APIã‹ã‚‰è¿”ã£ã¦ããŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—\nconst allItems = $input.all();\n\n// ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™\nif (!allItems || allItems.length === 0) {\n  return [];\n}\n\n// å„ã‚¢ã‚¤ãƒ†ãƒ ã®jsonãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º\nconst messages = allItems.map(item => item.json);\n\n// æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ\nconst sortedMessages = messages.sort((a, b) => b.send_time - a.send_time);\n\n// æœ€æ–°30ä»¶ã®ã¿å–å¾—ï¼ˆ100ã‹ã‚‰å¤‰æ›´ï¼‰\nconst recentMessages = sortedMessages\n  .slice(0, 30)\n  .map(msg => ({\n    message_id: msg.message_id,\n    account_name: msg.account?.name || 'Unknown',\n    body: msg.body || '',\n    send_time: msg.send_time\n  }));\n\n// n8nå½¢å¼ã§è¿”ã™\nreturn recentMessages.map(msg => ({ json: msg }));"
      },
      "id": "5ac6d3c9-bf94-4bc7-9efe-5a97e1152bfd",
      "name": "Filter Recent 100",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1456,
        1424
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "ã‚ãªãŸã¯ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã€Œè³ªå•ã€ã‚’æ¤œå‡ºã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚\n\n# è³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³\n1. ã€Œï¼Ÿã€ã§çµ‚ã‚ã‚‹\n2. ç–‘å•è©ã‚’å«ã‚€ï¼ˆã©ã“ã€ä½•ã€ã©ã†ã€ã„ã¤ã€èª°ã€ãªãœï¼‰\n3. ã€Œæ•™ãˆã¦ã€ã€Œã‚ã‹ã‚‰ãªã„ã€ã€Œå›°ã£ã¦ã„ã‚‹ã€ã€Œã§ããªã„ã€ãªã©ã®è¡¨ç¾\n4. æ˜ç¢ºãªç–‘å•ãƒ»è³ªå•ã®æ„å›³ãŒã‚ã‚‹ã‚‚ã®\n\n# é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³\n- æŒ¨æ‹¶ã®ã¿\n- é›‘è«‡\n- å˜ãªã‚‹å ±å‘Š\n\n# å‡ºåŠ›\nè³ªå•ã¨æ€ã‚ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®message_idã‚’é…åˆ—ã§è¿”ã—ã¦ãã ã•ã„ã€‚\nè³ªå•ã§ãªã„ã‚‚ã®ã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚\n\nå‡ºåŠ›å½¢å¼ï¼ˆå¿…ãšã“ã®å½¢å¼ã§ï¼‰ï¼š\n{\"question_ids\": [\"123456\", \"234567\"]}",
              "role": "system"
            },
            {
              "content": "=ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ:\n{{ JSON.stringify($input.all().map(item => ({ id: item.json.message_id, text: item.json.body }))) }}"
            }
          ]
        },
        "options": {
          "temperature": 0.3
        }
      },
      "id": "bd91099c-3603-457e-8eef-341ac93cb359",
      "name": "OpenAI Detect Questions",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [
        -1248,
        1424
      ],
      "credentials": {
        "openAiApi": {
          "id": "J33Jkek1x9rhPZBW",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// å…¨ã¦ã®OpenAIçµæœã‚’å–å¾—ï¼ˆ20ä»¶ï¼‰\nconst allAiResults = $input.all();\n\n// å…¨ã¦ã®è³ªå•IDã‚’æŠ½å‡ºã—ã¦çµ±åˆ\nconst allQuestionIds = new Set();\n\nallAiResults.forEach(item => {\n  try {\n    const content = item.json.message.content;\n    const parsed = JSON.parse(content);\n    const questionIds = parsed.question_ids || [];\n    \n    // Setã«IDã‚’è¿½åŠ ï¼ˆé‡è¤‡è‡ªå‹•æ’é™¤ï¼‰\n    questionIds.forEach(id => allQuestionIds.add(String(id)));\n  } catch (error) {\n    console.error('Failed to parse AI result:', error);\n  }\n});\n\n// Setã‚’é…åˆ—ã«å¤‰æ›\nconst questionIdsArray = Array.from(allQuestionIds);\n\nconsole.log('Detected question IDs:', questionIdsArray);\n\n// è³ªå•ãŒ0ä»¶ã®å ´åˆ\nif (questionIdsArray.length === 0) {\n  console.log('No questions detected');\n  return [];\n}\n\n// Filter Recent 100ã‹ã‚‰å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—\nconst allMessages = $('Filter Recent 100').all();\n\n// è³ªå•ã®ã¿ã‚’æŠ½å‡º\nconst questions = allMessages.filter(msg => {\n  const msgId = String(msg.json.message_id);\n  const isQuestion = questionIdsArray.includes(msgId);\n  \n  if (isQuestion) {\n    console.log('Found question:', msgId);\n  }\n  \n  return isQuestion;\n});\n\nconsole.log('Total questions found:', questions.length);\nreturn questions;"
      },
      "id": "2725af84-88d0-43e0-a516-fb2ef1ba5ec7",
      "name": "Parse Questions",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        1312
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "6d4d461d-631b-4bfc-8961-6b69a490e132",
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -848,
        1424
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "# å½¹å‰²\nãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è³ªå•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’FAQå½¢å¼ã«æ§‹é€ åŒ–ã™ã‚‹ã€‚\n\n# é‡è¦ï¼šå›ç­”ã¯å…·ä½“çš„ã«\n- å®Ÿéš›ã®è§£æ±ºç­–ã‚’æ¨æ¸¬ã—ã¦æ›¸ã\n- ã€Œã€œã—ã¦ãã ã•ã„ã€ã¨ã„ã†å…·ä½“çš„ãªæŒ‡ç¤ºã‚’å«ã‚ã‚‹\n- ãƒªãƒ³ã‚¯ã€æ‰‹é †ã€æœŸé™ãªã©ã€å…·ä½“çš„ãªæƒ…å ±ã‚’æ¨æ¸¬\n- æŠ½è±¡çš„ãªå•ã„ã‹ã‘ï¼ˆã€Œä½•ãŒè¦‹ãˆã¾ã™ã‹ï¼Ÿã€ç­‰ï¼‰ã¯ä½¿ã‚ãªã„\n\n# å‡ºåŠ›å½¢å¼ï¼ˆå¿…ãšJSONï¼‰\n{\n  \"title\": \"ç°¡æ½”ãªè³ªå•ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰\",\n  \"question\": \"è³ªå•ã®è©³ç´°ï¼ˆå…ƒã®è³ªå•ã‚’æ•´ç†ï¼‰\",\n  \"answer\": \"å…·ä½“çš„ãªè§£æ±ºç­–ï¼ˆæ¨æ¸¬ã§æ§‹ã‚ãªã„ã€150-300æ–‡å­—ï¼‰\",\n  \"category\": \"Weeké–¢é€£ | Sphereæ“ä½œ | ã‚³ãƒ¼ã‚¹é¸æŠ | ã‚·ã‚¹ãƒ†ãƒ  | ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ | ãã®ä»–\",\n  \"priority\": \"é«˜ | ä¸­ | ä½\"\n}\n\n# å›ç­”ã®ä¾‹\nè‰¯ã„ä¾‹ï¼š\nã€ŒWeek1ã®èª²é¡Œã¯ã€TriHexÎ¦ Discordã®#mirror-chatã«æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚\næå‡ºæœŸé™ã¯å„Weekã®æœ€çµ‚æ—¥23:59ã§ã™ã€‚ã€\n\næ‚ªã„ä¾‹ï¼š\nã€Œã©ã®ã‚ˆã†ã«æ„Ÿã˜ã¾ã™ã‹ï¼Ÿä½•ãŒè¦‹ãˆã¦ã„ã¾ã™ã‹ï¼Ÿã€\n```\n\n---\n\n### Phase 2ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰ï¼šå®Ÿéš›ã®å›ç­”ã‚’å–å¾—\n\n**ã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ï¼šå®Ÿéš›ã®å›ç­”ã‚’ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰å–å¾—**\n\n#### æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­è¨ˆï¼š\n```\n1. è³ªå•ã‚’æ¤œå‡ºï¼ˆç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰\n   â†“\n2. ãã®å¾Œã®è¿”ä¿¡ã‚’ç›£è¦–\n   â†“\n3. é‹å–¶ã‚¹ã‚¿ãƒƒãƒ•ã®å›ç­”ã‚’æ¤œå‡º\n   â†“\n4. è³ªå•ã¨å›ç­”ã‚’ãƒšã‚¢ã«ã—ã¦FAQã‚’æ›´æ–°",
              "role": "system"
            },
            {
              "content": "=è³ªå•è€…: {{ $json.account_name }}\n\nè³ªå•å†…å®¹:\n{{ $json.body }}"
            }
          ]
        },
        "options": {
          "temperature": 0.7
        }
      },
      "id": "5e3b95e3-cf59-4c67-8725-4785f6c0e660",
      "name": "OpenAI Structure FAQ",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [
        -656,
        1168
      ],
      "credentials": {
        "openAiApi": {
          "id": "J33Jkek1x9rhPZBW",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// OpenAI Structure FAQã®å‡ºåŠ›ã‚’å–å¾—\nconst aiResponse = $input.first().json;\nconst originalMessage = $('Split In Batches').first().json;\n\nlet faqData = {};\ntry {\n  const content = aiResponse.message.content;\n  faqData = JSON.parse(content);\n} catch (error) {\n  console.error('Failed to parse FAQ data:', error);\n  return [];\n}\n\n// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆfrequencyã¯å¾Œã§è¨­å®šï¼‰\nconst now = new Date();\nconst jstTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));\n\nreturn [{\n  json: {\n    timestamp: jstTime.toISOString(),\n    title: faqData.title || '',\n    question: faqData.question || '',\n    answer: faqData.answer || '',\n    category: faqData.category || '',\n    priority: faqData.priority || '',\n    chatwork_message_id: String(originalMessage.message_id || ''), // â† ä¿®æ­£ï¼\n    status: 'pending'\n  }\n}];\n"
      },
      "id": "58895b23-ff54-49d0-a7bd-ba783c6711c6",
      "name": "Add Metadata",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        1600
      ]
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "id": "ee5a3b43-3f9c-46ad-9048-dd9f3337cc0d",
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        464,
        1424
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1SywiLtNP759TQ_dWnYq1XftGTJprZOL9kVx5dlLiH_0",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "FAQ_Candidates",
          "mode": "name"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "title",
              "lookupValue": "={{ $json.title }}"
            }
          ]
        },
        "options": {
          "returnFirstMatch": "={{ true }}"
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -432,
        1424
      ],
      "id": "adf2258e-7f66-4f80-9908-ea773579e9ae",
      "name": "Lookup Existing FAQ",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YvL7P7HKwcuiK11r",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "852ed1e3-a26e-4e23-a4dc-809d5daf0e29",
              "leftValue": "={{ $('Lookup Existing FAQ').item }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -224,
        1424
      ],
      "id": "12d80b7f-b670-4388-b27a-364c32ba7da4",
      "name": "Duplicate Found?"
    },
    {
      "parameters": {
        "jsCode": "// Lookupã§è¦‹ã¤ã‹ã£ãŸæ—¢å­˜ãƒ‡ãƒ¼ã‚¿\nconst existingRow = $('Lookup Existing FAQ').first().json;\n\n// Add Metadataã‹ã‚‰ã®æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿\nconst newData = $('Add Metadata').first().json;\n\n// æ—¢å­˜ã®frequencyã‚’å–å¾—ï¼ˆæ•°å€¤å¤‰æ›ï¼‰\nconst currentFrequency = parseInt(existingRow.frequency) || 1;\nconst newFrequency = currentFrequency + 1;\n\n// æ—¢å­˜ã®chatwork_message_idã‚’å–å¾—ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¿½åŠ ï¼‰\nconst existingMessageIds = existingRow.chatwork_message_id || '';\nconst newMessageId = newData.chatwork_message_id;\nconst allMessageIds = existingMessageIds \n  ? `${existingMessageIds},${newMessageId}` \n  : newMessageId;\n\nconsole.log(`=== Duplicate Found ===`);\nconsole.log(`Title: ${newData.title}`);\nconsole.log(`Frequency: ${currentFrequency} â†’ ${newFrequency}`);\n\n// æ›´æ–°ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™\nreturn [{\n  json: {\n    // Lookupçµæœã‹ã‚‰è¡Œç•ªå·ã‚’å–å¾—ï¼ˆé‡è¦ï¼ï¼‰\n    rowNumber: existingRow.row_number,\n    \n    // æ›´æ–°ã™ã‚‹ãƒ‡ãƒ¼ã‚¿\n    timestamp: newData.timestamp,\n    title: newData.title,\n    question: newData.question,\n    answer: newData.answer,\n    category: newData.category,\n    priority: newData.priority,\n    frequency: newFrequency, // +1\n    chatwork_message_id: allMessageIds, // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¿½åŠ \n    status: newData.status\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        1328
      ],
      "id": "b00dddd7-25ff-4dad-9636-32063f71ad25",
      "name": "Calculate Frequency"
    },
    {
      "parameters": {
        "jsCode": "// Add Metadataã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿\nconst newData = $('Add Metadata').first().json;\n\nconsole.log(`=== New FAQ ===`);\nconsole.log(`Title: ${newData.title}`);\nconsole.log(`Category: ${newData.category}`);\n\n// æ–°è¦è¿½åŠ ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ï¼ˆfrequency = 1ï¼‰\nreturn [{\n  json: {\n    timestamp: newData.timestamp,\n    title: newData.title,\n    question: newData.question,\n    answer: newData.answer,\n    category: newData.category,\n    priority: newData.priority,\n    frequency: 1, // åˆæœŸå€¤\n    chatwork_message_id: newData.chatwork_message_id,\n    status: newData.status\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        1520
      ],
      "id": "a86a7521-c9a5-4961-9d24-1758130f2ae6",
      "name": "Set Initial Frequency"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1SywiLtNP759TQ_dWnYq1XftGTJprZOL9kVx5dlLiH_0",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "FAQ_Candidates",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "title"
          ],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "question",
              "displayName": "question",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "answer",
              "displayName": "answer",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "priority",
              "displayName": "priority",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "frequency",
              "displayName": "frequency",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chatwork_message_id",
              "displayName": "chatwork_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "rowNumber",
              "displayName": "rowNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        208,
        1328
      ],
      "id": "a6216f03-1ba3-4ffa-a555-7c2704f8f423",
      "name": "Update FAQ Row",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YvL7P7HKwcuiK11r",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1SywiLtNP759TQ_dWnYq1XftGTJprZOL9kVx5dlLiH_0",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "FAQ_Candidates",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "question",
              "displayName": "question",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "answer",
              "displayName": "answer",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "priority",
              "displayName": "priority",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "frequency",
              "displayName": "frequency",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chatwork_message_id",
              "displayName": "chatwork_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "rowNumber",
              "displayName": "rowNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        208,
        1520
      ],
      "id": "3775ea1f-f84a-40c1-a79a-5c69de6e5a96",
      "name": "Append New FAQ",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YvL7P7HKwcuiK11r",
          "name": "Google Sheets account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Get Ritual_Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Ritual_Log": {
      "main": [
        [
          {
            "node": "Filter Last 30 Days",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Last 30 Days": {
      "main": [
        [
          {
            "node": "Sort by Timestamp DESC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sort by Timestamp DESC": {
      "main": [
        [
          {
            "node": "Get Latest Entry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Latest Entry": {
      "main": [
        [
          {
            "node": "Has Recent Promotion?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Recent Promotion?": {
      "main": [
        [
          {
            "node": "Convert Role to ID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Recent Promotion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remove Discord Role": {
      "main": [
        [
          {
            "node": "Build Thread Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User_Progress": {
      "main": [
        [
          {
            "node": "Update User_Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update User_Progress": {
      "main": [
        [
          {
            "node": "Delete Ritual_Log Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Ritual_Log Row": {
      "main": [
        [
          {
            "node": "Post Rollback Notice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Role to ID": {
      "main": [
        [
          {
            "node": "Remove Discord Role",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Thread Name": {
      "main": [
        [
          {
            "node": "Rename Thread",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rename Thread": {
      "main": [
        [
          {
            "node": "Get User_Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Chatwork Get Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chatwork Get Messages": {
      "main": [
        [
          {
            "node": "Filter Recent 100",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Recent 100": {
      "main": [
        [
          {
            "node": "OpenAI Detect Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Detect Questions": {
      "main": [
        [
          {
            "node": "Parse Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Questions": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [],
        [
          {
            "node": "OpenAI Structure FAQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Structure FAQ": {
      "main": [
        [
          {
            "node": "Add Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Metadata": {
      "main": [
        [
          {
            "node": "Lookup Existing FAQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lookup Existing FAQ": {
      "main": [
        [
          {
            "node": "Duplicate Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Duplicate Found?": {
      "main": [
        [
          {
            "node": "Calculate Frequency",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Initial Frequency",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Frequency": {
      "main": [
        [
          {
            "node": "Update FAQ Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Initial Frequency": {
      "main": [
        [
          {
            "node": "Append New FAQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update FAQ Row": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append New FAQ": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "7704225d-9a80-40eb-9db4-5b42d6043705",
  "meta": {
    "instanceId": "bb6582f136488f8663186c75084ae9be2ac2ce1a6068064fd0778c5e05f7b8d2"
  },
  "id": "hbVaLNdjJXjSvECh",
  "tags": []
}