name: Claude PR Review

on:
  pull_request: { types: [opened, synchronize, reopened] }

jobs:
  review:
    runs-on: ubuntu-latest
    permissions: { contents: read, pull-requests: write }
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm install
          else
            npm init -y
            npm install @anthropic-ai/sdk
          fi
      
      - name: Diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > diff.patch || true
      
      - name: Ask Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_MODEL: claude-3-5-sonnet
        run: |
          cat > review-claude.mjs <<'EOF'
          import Anthropic from "@anthropic-ai/sdk";
          import { readFileSync } from "fs";
          
          const diff = readFileSync("diff.patch", "utf8");
          const c = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
          const r = await c.messages.create({
            model: process.env.CLAUDE_MODEL,
            max_tokens: 1400,
            system: "PR reviewer: concise, actionable, return fenced code patches.",
            messages: [{ role: "user", content: `Review this PR diff and suggest fixes:\n\n${diff}` }]
          });
          console.log(r.content?.map(x => x.text).join("\n") || "");
          EOF
          node review-claude.mjs > review.md
      
      - name: Comment
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ### ðŸ¤– Claude Review
            
            $(cat review.md)

