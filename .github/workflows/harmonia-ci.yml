name: Harmonia CI

on:
  push:
    paths:
      - '10_TriHexCore/**'
      - '20_TriHex-Obsidian/**'
      - '99_SYSTEM/**'
      - 'specs/**'
      - 'adr/**'
      - '10_CAPTURE_MIZUKAGAMI/**'
      - '20_CRYSTALLIZATION_KOKUYOU/**'
      - '.github/workflows/harmonia-ci.yml'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    env:
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    
    concurrency:
      group: trihex-ci
      cancel-in-progress: false
    
    # Skip if commit message contains [skip ci] or deployment markers
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[deploy')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping npm install"
          fi
      
      - name: Preflight Check
        run: node scripts/preflight-check.mjs || echo "Preflight check skipped"
      
      - name: Test Encoding
        run: npm run -s test:encoding || echo "Encoding test skipped"
      
      - name: Normalize Markdown
        run: node scripts/normalize-md.mjs 10_TriHexCore 20_TriHex-Obsidian 99_SYSTEM || echo "Normalization skipped"
      
      - name: Lint Markdown
        run: npx markdownlint-cli2 "**/*.md" || echo "Markdown linting skipped"
      
      - name: Frontmatter Check
        run: node scripts/check-frontmatter.mjs || echo "Frontmatter check skipped"
      
      - name: Spec Gate
        run: |
          # Ensure js-yaml is available (from package.json dependencies)
          if [ -f package.json ]; then
            npm ci || npm install
          fi
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E '\.md$|\.yml$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "$CHANGED_FILES" | xargs node scripts/spec-gate.mjs
          else
            echo "No spec files changed"
          fi
      
      - name: Mirror Codex
        run: node scripts/mirror-codex.mjs || echo "Mirror sync skipped"
      
      - name: Proof Stamp
        run: node scripts/proof-stamp.mjs || echo "Proof stamping skipped"
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: |
            99_SYSTEM/Proofs/HarmoniaCI_*.md
            *.log
          retention-days: 7
