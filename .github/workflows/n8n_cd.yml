name: ðŸš€ n8n CD

on:
  push:
    branches: [main]
    paths:
      - 'workflows/**'
      - '.github/workflows/n8n_cd.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-stg:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[deploy:stg]') || contains(github.event.head_commit.message, '[deploy]')
    environment: staging
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check Staging Secrets
        id: check_stg
        run: |
          if [ -z "${{ secrets.N8N_BASE_URL_STG }}" ] || [ -z "${{ secrets.N8N_API_KEY_STG }}" ]; then
            echo "âš ï¸ Staging secrets not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Staging secrets OK"
            echo "configured=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to n8n (staging)
        if: steps.check_stg.outputs.configured == 'true'
        run: |
          node tools/n8n-import.mjs --env=stg
        env:
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL_STG }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY_STG }}
      
      - name: Test staging
        if: steps.check_stg.outputs.configured == 'true'
        run: |
          node tools/test_ping.mjs --env=stg || echo "Test skipped"
        env:
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL_STG }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY_STG }}
      
      - name: Summary
        if: always()
        run: echo "## Staging Deploy" >> $GITHUB_STEP_SUMMARY
  
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[deploy:prod]')
    environment: 
      name: production
      url: https://railway.app
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check Prod Secrets
        id: check_prod
        run: |
          if [ -z "${{ secrets.N8N_BASE_URL_PROD }}" ] || [ -z "${{ secrets.N8N_API_KEY_PROD }}" ]; then
            echo "âš ï¸ Production secrets not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Production secrets OK"
            echo "configured=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to n8n (prod)
        if: steps.check_prod.outputs.configured == 'true'
        run: |
          node tools/n8n-import.mjs --env=prod
        env:
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL_PROD }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY_PROD }}
      
      - name: Test production
        if: steps.check_prod.outputs.configured == 'true'
        run: |
          node tools/test_ping.mjs --env=prod || echo "Test skipped"
          sleep 5
          node tools/test_line_fake.mjs --env=prod || echo "Test skipped"
        env:
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL_PROD }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY_PROD }}
      
      - name: Summary
        if: always()
        run: echo "## Production Deploy" >> $GITHUB_STEP_SUMMARY
