name: ðŸ”— TriHex CLI Bridge

on:
  discussion:
    types: [created]
  workflow_dispatch:
    inputs:
      discussion_body:
        description: 'Discussion body text'
        required: false
        type: string

permissions:
  contents: write
  discussions: write

jobs:
  run-trihex:
    name: TriHex CLI Execution
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Parse Discussion
        if: github.event_name == 'discussion'
        id: parse
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const discussionNumber = github.event.discussion.number;
            
            const query = `
              query($number: Int!) {
                repository(owner: "${github.repository_owner}", name: "${github.event.repository.name}") {
                  discussion(number: $number) {
                    title
                    body
                  }
                }
              }
            `;
            
            const data = await github.graphql(query, { number: discussionNumber });
            const discussion = data.repository.discussion;
            
            core.setOutput('title', discussion.title);
            core.setOutput('body', discussion.body);
            console.log(`âœ… Parsed discussion: ${discussion.title}`);
      
      - name: Run TriHex CLI
        id: trihex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TRIHEX_MODEL: gpt-4o
        run: |
          # Build prompt
          if [ "${{ github.event_name }}" = "discussion" ]; then
            PROMPT="Discussionsã®æ–°è¦ãƒˆãƒ”ãƒƒã‚¯ã‚’RyÅ«dÅ Roundã¨ã—ã¦åˆæœŸåŒ–ã€‚è¦æ—¨ã‚’è¦ç´„ã—ã€è©•ä¾¡è»¸=æ•´åˆ/æ·±åº¦/è©©/å‘¼å¸/ä¸‰è§’çµ±åˆã€Round_1.mdã‚’Obsidianã«ä¿å­˜ã€Master Reactivationã«ãƒªãƒ³ã‚¯ã‚’è¿½è¨˜ã€‚"
          else
            PROMPT="${{ github.event.inputs.discussion_body }}"
          fi
          
          echo "ðŸŽ¨ Executing TriHex CLI..."
          echo "Prompt: ${PROMPT}"
          
          # Run CLI and capture output
          OUTPUT=$(node tools/trihex/trihex.mjs --exec "${PROMPT}" 2>&1)
          echo "$OUTPUT" > trihex_output.txt
          
          echo "âœ… TriHex CLI completed"
          echo "output_file=trihex_output.txt" >> $GITHUB_OUTPUT
      
      - name: Save Output to Obsidian
        if: steps.trihex.outputs.output_file
        run: |
          mkdir -p "20_TriHex-Obsidian/04_HARMONIA_COUNCIL/Ryudo_Sessions"
          
          OUTPUT_CONTENT=$(cat trihex_output.txt)
          
          # Create Round file
          cat > "20_TriHex-Obsidian/04_HARMONIA_COUNCIL/Ryudo_Sessions/Round_1_$(date +%Y%m%d_%H%M%S).md" << EOF
          ---
          title: "RyÅ«dÅ Round 1"
          date: "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          phase: "V Aurum"
          source: "GitHub Discussion â†’ TriHex CLI"
          tags: ["#RyÅ«dÅ", "#Aurum", "#TriHex"]
          ---
          
          # RyÅ«dÅ Round 1
          
          **Generated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')  
          **Phase:** V Aurum  
          **Source:** Discussion â†’ TriHex CLI Bridge
          
          ---
          
          ## TriHex CLI Output
          
          ${OUTPUT_CONTENT}
          
          ---
          
          *Generated by TriHex CLI via GitHub Actions*
          
          EOF
          
          echo "âœ… Saved to Obsidian"
      
      - name: Commit Results
        run: |
          git config user.name "TriHex Bot"
          git config user.email "bot@trihex.local"
          
          git add -A
          
          if ! git diff --cached --quiet; then
            git commit -m "Aurum: Discussionâ†’TriHex CLI Initialization $(date +'%Y%m%d_%H%M%S')"
            git push origin main
            echo "âœ… Committed and pushed"
          else
            echo "âš ï¸ No changes to commit"
          fi
      
      - name: Update Master Reactivation
        if: steps.trihex.outputs.output_file
        run: |
          # Find the most recent Round file
          LATEST_ROUND=$(ls -t 20_TriHex-Obsidian/04_HARMONIA_COUNCIL/Ryudo_Sessions/Round_1_*.md | head -1)
          
          if [ -f "$LATEST_ROUND" ]; then
            RELATIVE_PATH="${LATEST_ROUND#20_TriHex-Obsidian/}"
            
            # Add link to Master Reactivation (if section exists)
            if grep -q "## Recent Sessions" TriHex_Master_Reactivation.md; then
              sed -i "/## Recent Sessions/a\\
- [$LATEST_ROUND](${RELATIVE_PATH})" TriHex_Master_Reactivation.md
            fi
            
            echo "âœ… Updated Master Reactivation"
          fi
      
      - name: Commit Reactivation Update
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Aurum: Add Round link to Master Reactivation"
            git push origin main
            echo "âœ… Reactivation update committed"
          fi
      
      - name: Generate Report
        if: always()
        run: |
          cat > bridge_report.md << EOF
          # TriHex Discussion Bridge Report
          
          **Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Phase:** V Aurum
          **Event:** ${{ github.event_name }}
          
          ## Results
          
          **Status:** ${{ steps.trihex.outputs.output_file && 'âœ… Success' || 'âŒ Failed' }}
          
          **Output:** trihex_output.txt
          **Obsidian:** $([ -f "20_TriHex-Obsidian/04_HARMONIA_COUNCIL/Ryudo_Sessions/"*.md ] && echo "Round file created" || echo "No Round file")
          
          EOF
          
          cat bridge_report.md
      
      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: bridge-report-${{ github.run_number }}
          path: |
            bridge_report.md
            trihex_output.txt


