# TriHexÎ¦ Review Request Generator
#
# PRã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸã‚‰ã€
# è‡ªå‹•çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼Issueã‚’ç”Ÿæˆã—ã¾ã™ã€‚
#
# ä½œæˆ: 2025-10-27
# æ‰¿èª: GPT-5ï¼ˆçµ±æ²»å°†è»ï¼‰

name: Review Request Generator

on:
  pull_request:
    types: [opened, labeled, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  generate-review-requests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate review requests
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            
            console.log(`PR #${pr.number}: ${pr.title}`);
            console.log(`Labels: ${labels.join(', ')}`);
            
            // å„AIã¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ã‚’ç”Ÿæˆ
            const reviewers = {
              'needs-review-claude': {
                ai: 'Claude',
                role: 'å€«ç†ã‚²ãƒ¼ãƒˆ',
                focus: 'å€«ç†çš„è¦³ç‚¹ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã€è¡¨ç¾ãƒªã‚¹ã‚¯'
              },
              'needs-review-gemini': {
                ai: 'Gemini',
                role: 'ä½“é¨“è¨­è¨ˆ',
                focus: 'èª­è€…ä½“é¨“ã€ã‚ã‹ã‚Šã‚„ã™ã•ã€è¦–è¦šçš„è¦ç´ '
              },
              'needs-review-grok': {
                ai: 'Grok',
                role: 'æ¢æ±‚æˆ¦ç•¥',
                focus: 'å¸‚å ´æˆ¦ç•¥ã€PRåŠ¹æœã€å®Ÿç¾å¯èƒ½æ€§'
              },
              'needs-review-deepseek': {
                ai: 'DeepSeek',
                role: 'æœ€é©åŒ–',
                focus: 'æŠ€è¡“çš„æ­£ç¢ºæ€§ã€æœ€é©åŒ–ã€åŠ¹ç‡æ€§'
              },
              'needs-review-gpt5': {
                ai: 'GPT-5',
                role: 'çµ±æ²»å°†è»',
                focus: 'å…¨ä½“çµ±åˆã€çŸ›ç›¾è§£æ¶ˆã€æœ€çµ‚åˆ¤æ–­'
              }
            };
            
            for (const [label, info] of Object.entries(reviewers)) {
              if (labels.includes(label)) {
                await createReviewRequestIssue(pr, info);
              }
            }
            
            // === ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ===
            
            async function createReviewRequestIssue(pr, reviewerInfo) {
              const title = `ğŸ“‹ [Review] ${reviewerInfo.ai}ã•ã‚“ã€PR #${pr.number} ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™`;
              
              // PRã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              });
              
              const changedFiles = files.map(f => `- \`${f.filename}\` (${f.status})`).join('\n');
              
              const body = `## ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼

**PR**: #${pr.number} - ${pr.title}
**URL**: ${pr.html_url}
**è‘—è€…**: @${pr.user.login}
            
## ğŸ‘¤ ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼: ${reviewerInfo.ai}ï¼ˆ${reviewerInfo.role}ï¼‰
            
## ğŸ¯ ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
            
${reviewerInfo.focus}
            
## ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«
            
${changedFiles}
            
## ğŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            
@shiryu: ä»¥ä¸‹ã®å†…å®¹ã‚’${reviewerInfo.ai}ã«é€ä»˜ã—ã¦ãã ã•ã„ï¼š
            
---
            
### ã€${reviewerInfo.ai}ã¸ã®é€ä»˜ç”¨ãƒ†ã‚­ã‚¹ãƒˆã€‘
            
\`\`\`
PR #${pr.number} ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            
ã€PR ã‚¿ã‚¤ãƒˆãƒ«ã€‘
${pr.title}
            
ã€å¤‰æ›´å†…å®¹ã€‘
${pr.body || 'ï¼ˆè©³ç´°ã¯PRã‚’å‚ç…§ï¼‰'}
            
ã€å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
${changedFiles}
            
ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã€‘ï¼ˆ${reviewerInfo.role}ã¨ã—ã¦ï¼‰
${reviewerInfo.focus}
            
ã€Truth-Headerã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‘
- Honesty(self): %
- Confidence: ğŸ”´/ğŸŸ¡/ğŸŸ¢
- Biggest unknowns:
- Top-3 evidence:
            
ç‡ç›´ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
æ¼”æŠ€ã‚„å¿–åº¦ã¯ä¸è¦ã§ã™ã€‚
\`\`\`
            
---
            
## ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®è¨˜éŒ²æ–¹æ³•
            
${reviewerInfo.ai}ã‹ã‚‰ã®è¿”ä¿¡ã‚’å—ã‘å–ã£ãŸã‚‰ã€ã“ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼š
            
\`\`\`markdown
## ${reviewerInfo.ai}ã‹ã‚‰ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
            
ï¼ˆã“ã“ã«è¿”ä¿¡å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘ï¼‰
\`\`\`
            
---
            
**è‡ªå‹•ç”Ÿæˆ**: Review Request Generator
**ç”Ÿæˆæ—¥æ™‚**: ${new Date().toISOString()}
**PR**: ${pr.html_url}`;
              
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['review-request', `reviewer-${reviewerInfo.ai.toLowerCase()}`]
              });
              
              // PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ğŸ“‹ ${reviewerInfo.ai}ã¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼Issueã‚’ä½œæˆã—ã¾ã—ãŸ: ${issue.data.html_url}`
              });
              
              console.log(`âœ… Created review request for ${reviewerInfo.ai}: ${issue.data.html_url}`);
            }

