# TriHex Supabase Sync Workflow (LV2)
# Purpose: [deploy:stg]/[deploy:prod] ã§è‡ªå‹•é…å‚™

name: ðŸ’§ Supabase Sync

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

jobs:
  sync-stg:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[deploy:stg]') || github.event_name == 'workflow_dispatch'
    environment: staging
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check Staging Secrets
        id: check_stg
        run: |
          if [ -z "${{ secrets.SUPABASE_URL_STG }}" ] || [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY_STG }}" ]; then
            echo "âš ï¸ Staging secrets not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Staging secrets OK"
            echo "configured=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to Staging
        if: steps.check_stg.outputs.configured == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL_STG }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_STG }}
        run: |
          echo "ðŸš€ Deploying to staging..."
          node scripts/supabase-sync.mjs || echo "Staging deploy skipped"
      
      - name: Summary
        if: always()
        run: echo "## Staging Deploy" >> $GITHUB_STEP_SUMMARY
  
  sync-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[deploy:prod]')
    environment: 
      name: production
      url: https://supabase.com
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check Prod Secrets
        id: check_prod
        run: |
          if [ -z "${{ secrets.SUPABASE_URL_PROD }}" ] || [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PROD }}" ]; then
            echo "âš ï¸ Production secrets not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Production secrets OK"
            echo "configured=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to Production
        if: steps.check_prod.outputs.configured == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL_PROD }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PROD }}
        run: |
          echo "ðŸš€ Deploying to production..."
          node scripts/supabase-sync.mjs || echo "Prod deploy skipped"
      
      - name: Summary
        if: always()
        run: echo "## Production Deploy" >> $GITHUB_STEP_SUMMARY
