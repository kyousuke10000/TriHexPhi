# TriHexÎ¦ Task Issue Generator
# 
# æ–°ã—ã„æ±ºå®šæ–‡æ›¸ã‚„Tierä»˜ããƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œçŸ¥ã—ã¦ã€
# è‡ªå‹•çš„ã«ã‚¿ã‚¹ã‚¯Issueã‚’ç”Ÿæˆã—ã¾ã™ã€‚
#
# ä½œæˆ: 2025-10-27
# æ‰¿èª: GPT-5ï¼ˆçµ±æ²»å°†è»ï¼‰

name: Task Issue Generator

on:
  push:
    branches:
      - main
      - feature/**
    paths:
      - 'decisions/**'
      - 'stories/**'
      - '_inbox/**'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  generate-tasks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å‰å›ã®ã‚³ãƒŸãƒƒãƒˆã¨æ¯”è¼ƒã™ã‚‹ãŸã‚
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install --no-save js-yaml gray-matter
      
      - name: Analyze new files and generate tasks
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const matter = require('gray-matter');
            const yaml = require('js-yaml');
            
            // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            const { data: files } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.before,
              head: context.payload.after,
            });
            
            const addedFiles = files.files.filter(f => 
              f.status === 'added' && f.filename.endsWith('.md')
            );
            
            console.log(`Found ${addedFiles.length} new markdown files`);
            
            for (const file of addedFiles) {
              try {
                const content = fs.readFileSync(file.filename, 'utf8');
                const { data: frontmatter } = matter(content);
                
                if (!frontmatter.trihex) continue;
                
                const trihex = frontmatter.trihex;
                
                // Tier 1ã®ãƒ•ã‚¡ã‚¤ãƒ« â†’ è‹±è¨³ã‚¿ã‚¹ã‚¯ç”Ÿæˆ
                if (trihex.tier === 1 && trihex.kind === 'decision') {
                  await createTranslationTask(file.filename, trihex);
                }
                
                // Decisionãƒ•ã‚¡ã‚¤ãƒ« â†’ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¹ã‚¯ç”Ÿæˆ
                if (trihex.kind === 'decision' && trihex.status === 'draft') {
                  await createReviewTask(file.filename, trihex);
                }
                
              } catch (error) {
                console.error(`Error processing ${file.filename}:`, error);
              }
            }
            
            // === ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ===
            
            async function createTranslationTask(filename, trihex) {
              const title = `ğŸ“‹ [Tier 1] ${trihex.title} è‹±è¨³ã‚¿ã‚¹ã‚¯`;
              
              const body = `## ğŸ“ ã‚¿ã‚¹ã‚¯
            
**ãƒ•ã‚¡ã‚¤ãƒ«**: \`${filename}\`
**ã‚¿ã‚¤ãƒˆãƒ«**: ${trihex.title}
**å„ªå…ˆåº¦**: Tier ${trihex.tier}
            
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®è‹±è¨³ãŒå¿…è¦ã§ã™ã€‚
            
## ğŸ‘¥ æ‹…å½“
            
- **Primary**: @Cursorï¼ˆå®Ÿè£…ï¼‰
- **Review**: @Geminiï¼ˆä½“é¨“è¨­è¨ˆï¼‰, @Claudeï¼ˆå€«ç†ãƒã‚§ãƒƒã‚¯ï¼‰
            
## ğŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            
@shiryu: Cursorã«ä»¥ä¸‹ã‚’æŒ‡ç¤ºã—ã¦ãã ã•ã„ï¼š
            
\`\`\`
ã€Œ${filename}ã€ã‚’è‹±è¨³ã—ã¦ãã ã•ã„ã€‚
Tier 1ãªã®ã§ã€48æ™‚é–“ä»¥å†…ã«å®Œäº†ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            
å‚è€ƒ:
- DEC_2025-10-27_ENG-STRATEGY_v1.md
- ç·¨é›†åŸºæº–ã«å¾“ã£ã¦ã€æ ¸å¿ƒã‚’æ®‹ã—ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’ä¿è­·
\`\`\`
            
## ğŸ“š å‚è€ƒæ–‡æ›¸
            
- [è‹±è¨³æˆ¦ç•¥æ±ºå®šæ–‡æ›¸](../decisions/DEC_2025-10-27_ENG-STRATEGY_v1.md)
- [ç·¨é›†åŸºæº–](../decisions/DEC_2025-10-27_ENG-STRATEGY_v1.md#4-ç·¨é›†åŸºæº–æ®‹ã™å‰Šã‚‹)
            
---
            
**è‡ªå‹•ç”Ÿæˆ**: Task Issue Generator
**ç”Ÿæˆæ—¥æ™‚**: ${new Date().toISOString()}`;
              
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['task', 'translation', 'tier-1', 'cursor-action-required']
              });
              
              console.log(`âœ… Created translation task: ${issue.data.html_url}`);
            }
            
            async function createReviewTask(filename, trihex) {
              const title = `ğŸ“‹ [Review] ${trihex.title} ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼`;
              
              const body = `## ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡
            
**ãƒ•ã‚¡ã‚¤ãƒ«**: \`${filename}\`
**ã‚¿ã‚¤ãƒˆãƒ«**: ${trihex.title}
**è‘—è€…**: ${trihex.author}
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${trihex.status}
            
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚
            
## ğŸ‘¥ ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼
            
- **Claude**: å€«ç†çš„è¦³ç‚¹ã€è¡¨ç¾ãƒªã‚¹ã‚¯
- **Gemini**: èª­è€…ä½“é¨“ã€ã‚ã‹ã‚Šã‚„ã™ã•
- **Grok**: å¸‚å ´æˆ¦ç•¥ã€å®Ÿç¾å¯èƒ½æ€§
- **DeepSeek**: æŠ€è¡“çš„æ­£ç¢ºæ€§ã€æœ€é©åŒ–
            
## ğŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            
@shiryu: å„AIã«ä»¥ä¸‹ã‚’é€ä»˜ã—ã¦ãã ã•ã„ï¼š
            
### Claudeã¸ï¼ˆå€«ç†ãƒã‚§ãƒƒã‚¯ï¼‰
            
\`\`\`
ä»¥ä¸‹ã®æ±ºå®šæ–‡æ›¸ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼ˆå€«ç†çš„è¦³ç‚¹ï¼‰ï¼š
            
ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€‘: ${filename}
ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘: ${trihex.title}
            
ãƒã‚§ãƒƒã‚¯é …ç›®:
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã¯ååˆ†ã‹
- è¡¨ç¾ã«ãƒªã‚¹ã‚¯ã¯ãªã„ã‹
- çœŸå®Ÿæ€§æ†²æ³•ã¨ã®æ•´åˆæ€§
            
ç‡ç›´ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
\`\`\`
            
### Geminiã¸ï¼ˆä½“é¨“è¨­è¨ˆï¼‰
            
\`\`\`
ä»¥ä¸‹ã®æ±ºå®šæ–‡æ›¸ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼ˆèª­è€…ä½“é¨“ï¼‰ï¼š
            
ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€‘: ${filename}
ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘: ${trihex.title}
            
ãƒã‚§ãƒƒã‚¯é …ç›®:
- ã‚ã‹ã‚Šã‚„ã™ã„ã‹
- æ§‹æˆã¯é©åˆ‡ã‹
- è¦–è¦šçš„è¦ç´ ã¯å¿…è¦ã‹
            
èª­è€…ã®ç«‹å ´ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
\`\`\`
            
---
            
**è‡ªå‹•ç”Ÿæˆ**: Task Issue Generator
**ç”Ÿæˆæ—¥æ™‚**: ${new Date().toISOString()}`;
              
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['review', 'needs-claude', 'needs-gemini']
              });
              
              console.log(`âœ… Created review task: ${issue.data.html_url}`);
            }

