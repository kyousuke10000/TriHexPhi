name: ğŸ”± TriHexÎ¦ AI Review (Discussions)

on:
  workflow_dispatch:
    inputs:
      target_file:
        description: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«'
        required: true
        default: 'ğŸ“¤Round3_å…¨AIé€ä»˜ç”¨/Strategic_Plan_v1.0_2025-10-26.md'

permissions:
  contents: write
  issues: write
  pull-requests: write
  discussions: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: "ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4
      
      - name: "Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: "ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        run: |
          pip install openai anthropic google-generativeai requests
      
      - name: "Phase 0: Discussionä½œæˆ"
        id: create_discussion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const timestamp = new Date().toISOString();
            const discussionBody = `# ğŸ”±ğŸ’âœ¨ TriHexÎ¦ AI Review System âœ¨ğŸ’ğŸ”±
            
            **é–‹å§‹æ™‚åˆ»:** ${timestamp}
            **ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡:** ${{ github.event.inputs.target_file }}
            **ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** v3.0 (Discussions)
            
            ---
            
            ## ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼é€²è¡ŒçŠ¶æ³
            
            ã“ã®Discussionã§ã¯ã€6AIè»å¸«å›£ã«ã‚ˆã‚‹å”åƒãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé€²è¡Œã—ã¾ã™ã€‚
            å„AIã®å°‚é–€æ€§ã‚’æ´»ã‹ã—ãŸå¤šè§’çš„ãªåˆ†æã«ã‚ˆã‚Šã€ç·åˆçš„ãªè©•ä¾¡ã‚’æä¾›ã—ã¾ã™ã€‚
            
            ### ğŸ¤– AIè»å¸«å›£ãƒ¡ãƒ³ãƒãƒ¼
            
            - **GPT-5 (å¤§è»å¸«)**: å…¨ä½“æˆ¦ç•¥ãƒ»çµ±æ‹¬
            - **Claude (å€«ç†å‚è¬€)**: ãƒªã‚¹ã‚¯ç®¡ç†ãƒ»å€«ç†
            - **Gemini (ç¾çš„è»å¸«)**: UI/UXãƒ»å¯è¦–åŒ–
            - **Grok (å¸‚å ´å‚è¬€)**: å¸‚å ´åˆ†æãƒ»ãƒãƒã‚¿ã‚¤ã‚º
            - **DeepSeek (æŠ€è¡“è»å¸«)**: æŠ€è¡“æœ€é©åŒ–
            - **Cursor (å®Ÿè¡Œéƒ¨éšŠé•·)**: å®Ÿè£…æ”¯æ´
            
            ---
            
            ## â³ é€²æ—
            
            ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œä¸­... å„AIã‹ã‚‰ã®å›ç­”ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
            `;
            
            // GraphQL mutation ã§Discussionä½œæˆ
            const mutation = `
              mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                createDiscussion(input: {
                  repositoryId: $repositoryId,
                  categoryId: $categoryId,
                  title: $title,
                  body: $body
                }) {
                  discussion {
                    id
                    number
                    url
                  }
                }
              }
            `;
            
            // ãƒªãƒã‚¸ãƒˆãƒªIDã‚’å–å¾—
            const repoQuery = `
              query($owner: String!, $name: String!) {
                repository(owner: $owner, name: $name) {
                  id
                  discussionCategories(first: 10) {
                    nodes {
                      id
                      name
                    }
                  }
                }
              }
            `;
            
            const repoData = await github.graphql(repoQuery, {
              owner: context.repo.owner,
              name: context.repo.repo
            });
            
            const repositoryId = repoData.repository.id;
            
            // ã‚«ãƒ†ã‚´ãƒªIDã‚’å–å¾—ï¼ˆ"AI Review"ã‚«ãƒ†ã‚´ãƒªï¼‰
            let categoryId = repoData.repository.discussionCategories.nodes
              .find(cat => cat.name === "AI Review")?.id;
            
            // ã‚«ãƒ†ã‚´ãƒªãŒãªã„å ´åˆã¯Generalã‚’ä½¿ç”¨
            if (!categoryId) {
              categoryId = repoData.repository.discussionCategories.nodes[0]?.id;
            }
            
            const title = `ğŸ“¤ AIãƒ¬ãƒ“ãƒ¥ãƒ¼: ${{ github.event.inputs.target_file }} (${new Date().toLocaleString('ja-JP')})`;
            
            const result = await github.graphql(mutation, {
              repositoryId: repositoryId,
              categoryId: categoryId,
              title: title,
              body: discussionBody
            });
            
            const discussionNumber = result.createDiscussion.discussion.number;
            const discussionUrl = result.createDiscussion.discussion.url;
            
            console.log(`âœ… Discussion #${discussionNumber} ä½œæˆå®Œäº†: ${discussionUrl}`);
            
            core.setOutput('discussion_number', discussionNumber);
            core.setOutput('discussion_id', result.createDiscussion.discussion.id);
            core.setOutput('discussion_url', discussionUrl);
      
      - name: "Phase 1: GPT-5 ãƒ¬ãƒ“ãƒ¥ãƒ¼"
        id: gpt5
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ“¤ GPT-5 ã«é€ä¿¡ä¸­..."
          python3 .github/scripts/review_gpt5.py "${{ github.event.inputs.target_file }}"
      
      - name: "GPT-5çµæœã‚’Discussionã«æŠ•ç¨¿"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const gpt5Review = fs.readFileSync('gpt5_review.txt', 'utf8');
            
            const mutation = `
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId,
                  body: $body
                }) {
                  comment {
                    id
                  }
                }
              }
            `;
            
            const body = `## ğŸ¤– GPT-5 ãƒ¬ãƒ“ãƒ¥ãƒ¼
            
            ${gpt5Review}
            
            ---
            
            ğŸ“Š é€²æ—: 1/5 å®Œäº†`;
            
            await github.graphql(mutation, {
              discussionId: '${{ steps.create_discussion.outputs.discussion_id }}',
              body: body
            });
      
      - name: "Phase 2: Claude ãƒ¬ãƒ“ãƒ¥ãƒ¼"
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ“¤ Claude ã«é€ä¿¡ä¸­..."
          python3 .github/scripts/review_claude.py "${{ github.event.inputs.target_file }}"
      
      - name: "Claudeçµæœã‚’Discussionã«æŠ•ç¨¿"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const claudeReview = fs.readFileSync('claude_review.txt', 'utf8');
            
            const mutation = `
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId,
                  body: $body
                }) {
                  comment {
                    id
                  }
                }
              }
            `;
            
            const body = `## ğŸ¤– Claude ãƒ¬ãƒ“ãƒ¥ãƒ¼
            
            ${claudeReview}
            
            ---
            
            ğŸ“Š é€²æ—: 2/5 å®Œäº†`;
            
            await github.graphql(mutation, {
              discussionId: '${{ steps.create_discussion.outputs.discussion_id }}',
              body: body
            });
      
      - name: "Phase 3: Gemini ãƒ¬ãƒ“ãƒ¥ãƒ¼"
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ“¤ Gemini ã«é€ä¿¡ä¸­..."
          python3 .github/scripts/review_gemini.py "${{ github.event.inputs.target_file }}"
      
      - name: "Geminiçµæœã‚’Discussionã«æŠ•ç¨¿"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const geminiReview = fs.readFileSync('gemini_review.txt', 'utf8');
            
            const mutation = `
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId,
                  body: $body
                }) {
                  comment {
                    id
                  }
                }
              }
            `;
            
            const body = `## ğŸ¤– Gemini ãƒ¬ãƒ“ãƒ¥ãƒ¼
            
            ${geminiReview}
            
            ---
            
            ğŸ“Š é€²æ—: 3/5 å®Œäº†`;
            
            await github.graphql(mutation, {
              discussionId: '${{ steps.create_discussion.outputs.discussion_id }}',
              body: body
            });
      
      - name: "Phase 4: Grok ãƒ¬ãƒ“ãƒ¥ãƒ¼"
        id: grok
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          echo "ğŸ“¤ Grok ã«é€ä¿¡ä¸­..."
          python3 .github/scripts/grok_review_final.py "${{ github.event.inputs.target_file }}"
      
      - name: "Grokçµæœã‚’Discussionã«æŠ•ç¨¿"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const grokReview = fs.readFileSync('grok_review.txt', 'utf8');
            
            const mutation = `
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId,
                  body: $body
                }) {
                  comment {
                    id
                  }
                }
              }
            `;
            
            const body = `## ğŸ¤– Grok ãƒ¬ãƒ“ãƒ¥ãƒ¼
            
            ${grokReview}
            
            ---
            
            ğŸ“Š é€²æ—: 4/5 å®Œäº†`;
            
            await github.graphql(mutation, {
              discussionId: '${{ steps.create_discussion.outputs.discussion_id }}',
              body: body
            });
      
      - name: "Phase 5: DeepSeek ãƒ¬ãƒ“ãƒ¥ãƒ¼"
        id: deepseek
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ğŸ“¤ DeepSeek ã«é€ä¿¡ä¸­..."
          python3 .github/scripts/review_deepseek.py "${{ github.event.inputs.target_file }}"
      
      - name: "DeepSeekçµæœã‚’Discussionã«æŠ•ç¨¿"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const deepseekReview = fs.readFileSync('deepseek_review.txt', 'utf8');
            
            const mutation = `
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId,
                  body: $body
                }) {
                  comment {
                    id
                  }
                }
              }
            `;
            
            const body = `## ğŸ¤– DeepSeek ãƒ¬ãƒ“ãƒ¥ãƒ¼
            
            ${deepseekReview}
            
            ---
            
            ğŸ“Š é€²æ—: 5/5 å®Œäº†`;
            
            await github.graphql(mutation, {
              discussionId: '${{ steps.create_discussion.outputs.discussion_id }}',
              body: body
            });
      
      - name: "Phase 6: å®Œäº†é€šçŸ¥"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const mutation = `
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId,
                  body: $body
                }) {
                  comment {
                    id
                  }
                }
              }
            `;
            
            const timestamp = new Date().toISOString();
            
            const body = `# ğŸ‰ å…¨5AIãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ï¼
            
            **å®Œäº†æ™‚åˆ»:** ${timestamp}
            **ç·å‡¦ç†æ™‚é–“:** ç´„3-5åˆ†
            
            ---
            
            ## âœ… å®Œäº†ã—ãŸAI
            
            - âœ… GPT-5 (å¤§è»å¸«)
            - âœ… Claude (å€«ç†å‚è¬€)
            - âœ… Gemini (ç¾çš„è»å¸«)
            - âœ… Grok (å¸‚å ´å‚è¬€)
            - âœ… DeepSeek (æŠ€è¡“è»å¸«)
            
            ---
            
            ## ğŸ“Š æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            
            å„AIã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’çµ±åˆã—ã¦ã€ç·åˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚
            
            ğŸ”±ğŸ’âœ¨ TriHexÎ¦ - AIå”åƒãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº† âœ¨ğŸ’ğŸ”±`;
            
            await github.graphql(mutation, {
              discussionId: '${{ steps.create_discussion.outputs.discussion_id }}',
              body: body
            });
            
            console.log("âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†é€šçŸ¥ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ");
            console.log("Discussion URL: ${{ steps.create_discussion.outputs.discussion_url }}");
      
      - name: "Discussionã‚’Obsidianã«åŒæœŸ"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Discussionå†…å®¹ã‚’å–å¾—
            const discussionQuery = `
              query($number: Int!) {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  discussion(number: $number) {
                    number
                    title
                    body
                    createdAt
                    url
                    comments(first: 100) {
                      nodes {
                        body
                        createdAt
                        author {
                          login
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const discussionData = await github.graphql(discussionQuery, {
              number: ${{ steps.create_discussion.outputs.discussion_number }}
            });
            
            const discussion = discussionData.repository.discussion;
            
            // Obsidianãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
            const discussionDir = '10_CAPTURE_MIZUKAGAMI/GitHub/Discussions';
            const fileName = `Discussion_${discussion.number}_${discussion.title.replace(/[^a-zA-Z0-9]/g, '_')}.md`;
            const filePath = path.join(discussionDir, fileName);
            
            // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
            if (!fs.existsSync(discussionDir)) {
              fs.mkdirSync(discussionDir, { recursive: true });
            }
            
            // Markdownç”Ÿæˆ
            let obsidianContent = '';
            obsidianContent += '---\n';
            obsidianContent += 'type: github_discussion\n';
            obsidianContent += `discussion_number: ${discussion.number}\n`;
            obsidianContent += `created: ${discussion.createdAt}\n`;
            obsidianContent += `discussion_url: ${discussion.url}\n`;
            obsidianContent += 'tags: [#GitHub, #Discussions, #å®Œç’§è»è­°, #Round3]\n';
            obsidianContent += '---\n\n';
            obsidianContent += `# ${discussion.title}\n\n`;
            obsidianContent += `**Discussion URL**: [GitHub Discussion #${discussion.number}](${discussion.url})\n\n`;
            obsidianContent += '---\n\n';
            obsidianContent += '## ğŸ“ å†…å®¹\n\n';
            obsidianContent += `${discussion.body}\n\n`;
            obsidianContent += '---\n\n';

            // ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            if (discussion.comments.nodes.length > 0) {
              obsidianContent += '## ğŸ’¬ AIãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n';
              discussion.comments.nodes.forEach((comment, index) => {
                obsidianContent += `### ${comment.author.login} - Review ${index + 1}\n\n`;
                obsidianContent += `${comment.body}\n\n`;
                obsidianContent += '---\n\n';
              });
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
            fs.writeFileSync(filePath, obsidianContent);
            console.log(`âœ… Obsidianãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†: ${filePath}`);
            
            // å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
            const { execSync } = require('child_process');
            execSync('git config user.name "TriHexÎ¦ Bot"');
            execSync('git config user.email "bot@trihexphi.local"');
            execSync('git add .');
            execSync(`git commit -m "feat: GitHub Discussion #${discussion.number} ã‚’ Obsidian ã«åŒæœŸ" || echo "No changes to commit"`);
            execSync('git push');
        

