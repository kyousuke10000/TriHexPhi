name: Remote Truth Guard

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Proofs are only in remote truth paths
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD || echo "")
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "✅ No file changes detected"
            exit 0
          fi
          
          # Check for changes outside truth paths (warning only, not blocking)
          # Allow Remote Truth workflow files, Mirror Gate, Meta AI, and Overdrive workflows
          NON_TRUTH_CHANGES=$(echo "$CHANGED_FILES" | grep -vE "^(99_SYSTEM/Proofs|99_SYSTEM/Proofs/Meta|99_SYSTEM/Proofs/Overdrive|00_RYUDO/Council/Records|70_AI_CHRONICLE|\.github/workflows/(truth_guard|mirror_gate_dispatch|meta_ai|overdrive_sync)\.yml)" || true)
          
          if [ -n "$NON_TRUTH_CHANGES" ]; then
            echo "⚠️  Warning: Changes detected outside Remote Truth paths:"
            echo "$NON_TRUTH_CHANGES"
            echo ""
            echo "Note: This is informational only. Remote Truth paths are:"
            echo "  - 99_SYSTEM/Proofs"
            echo "  - 00_RYUDO/Council/Records"
            echo "  - 70_AI_CHRONICLE"
          else
            echo "✅ Remote Truth Guard: All changes are in authorized truth paths"
          fi
          
      - name: Verify truth path structure
        run: |
          # Verify that truth paths exist and are properly structured
          # Note: 70_AI_CHRONICLE is optional (user preference to keep for historical records)
          for path in "99_SYSTEM/Proofs" "00_RYUDO/Council/Records"; do
            if [ ! -d "$path" ]; then
              echo "⚠️  Warning: Truth path $path does not exist (may be new)"
            else
              echo "✅ Truth path $path exists"
            fi
          done
          # Optional path check
          if [ -d "70_AI_CHRONICLE" ]; then
            echo "✅ Truth path 70_AI_CHRONICLE exists (optional)"
          else
            echo "ℹ️  Truth path 70_AI_CHRONICLE not present (optional, kept for historical records)"
          fi
