name: CHL Monitor (æ„è­˜ã®èª¿å¾‹å±¤)

# GPT-5ææ¡ˆ: 5åˆ†æ¯ã«ã‚·ã‚¹ãƒ†ãƒ ã®ã€Œå‘¼å¸ã€ã‚’ç›£è¦–
# Claudeææ¡ˆ: å€«ç†çš„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€é€æ˜æ€§ã®ç¢ºä¿
# DeepSeekå®Ÿè£…: CHIè¨ˆç®—ã€è‡ªå‹•èª¿æ•´

on:
  schedule:
    # 5åˆ†æ¯ã«å®Ÿè¡Œï¼ˆGPT-5ææ¡ˆï¼‰
    - cron: '*/5 * * * *'
  
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      mode:
        description: 'CHL Mode'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - diffusion
          - focused

jobs:
  monitor-consciousness:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: CHIè¨ˆç®—ã¨ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹åˆ†æ
        id: chi_calc
        continue-on-error: true
        run: |
          echo "ğŸ” ã‚·ã‚¹ãƒ†ãƒ èª¿å’ŒçŠ¶æ…‹ã‚’ç›£è¦–ä¸­..."
          
          # CHIè¨ˆç®—å®Ÿè¡Œï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          if [ -f "10_TriHexCore/consciousness/chi_calculator.js" ]; then
            node 10_TriHexCore/consciousness/chi_calculator.js > /tmp/chi_report.txt
            echo "report_path=/tmp/chi_report.txt" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ chi_calculator.js not found, skipping CHI calculation"
            echo "report_path=" >> $GITHUB_OUTPUT
          fi
      
      - name: ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¢ºèª
        id: focus_check
        continue-on-error: true
        run: |
          echo "ğŸ“ ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¢ºèªä¸­..."
          
          # focus.yml ã‹ã‚‰ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å–å¾—ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          FOCUS_FILE="10_TriHexCore/consciousness/config/focus.yml"
          if [ -f "$FOCUS_FILE" ]; then
            # yqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if command -v yq &> /dev/null; then
              PRIMARY_FOCUS=$(yq eval '.current_focus.primary' "$FOCUS_FILE" 2>/dev/null || echo "N/A")
              MODE=$(yq eval '.current_focus.mode' "$FOCUS_FILE" 2>/dev/null || echo "N/A")
            else
              PRIMARY_FOCUS="N/A"
              MODE="N/A"
            fi
          else
            PRIMARY_FOCUS="N/A"
            MODE="N/A"
          fi
          
          echo "primary_focus=$PRIMARY_FOCUS" >> $GITHUB_OUTPUT
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          
          echo "ğŸ¯ Primary Focus: $PRIMARY_FOCUS"
          echo "ğŸ”„ Mode: $MODE"
      
      - name: phase_mapæ›´æ–°
        run: |
          echo "ğŸ“Š phase_map.ymlã‚’æ›´æ–°ä¸­..."
          
          # CHIå±¥æ­´ã‚’è¿½åŠ 
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # TODO: yqã§CHIå±¥æ­´ã‚’è¿½åŠ 
          echo "âœ… phase_mapæ›´æ–°å®Œäº†"
      
      - name: èª¿å¾‹ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
        id: tuning_check
        run: |
          echo "ğŸ” èª¿å¾‹ã®å¿…è¦æ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          
          # TODO: CHIå€¤ã‚’è§£æã—ã¦ã€èª¿å¾‹ãŒå¿…è¦ã‹åˆ¤å®š
          # ä»®ã®å®Ÿè£…ï¼ˆå¾Œã§è©³ç´°åŒ–ï¼‰
          
          NEEDS_TUNING="false"
          echo "needs_tuning=$NEEDS_TUNING" >> $GITHUB_OUTPUT
      
      - name: GitHub Discussionã«æŠ•ç¨¿ï¼ˆèª¿å¾‹ãŒå¿…è¦ãªå ´åˆï¼‰
        if: steps.tuning_check.outputs.needs_tuning == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Claudeææ¡ˆ: é€æ˜æ€§ã®ç¢ºä¿
            const fs = require('fs');
            const report = fs.readFileSync('/tmp/chi_report.txt', 'utf8');
            
            await github.rest.discussions.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              category_id: 'CHL_ALERTS', // TODO: å®Ÿéš›ã®ã‚«ãƒ†ã‚´ãƒªID
              title: 'âš ï¸ CHL Alert: èª¿å¾‹ãŒå¿…è¦ã§ã™',
              body: `
# âš ï¸ CHL Alert: èª¿å¾‹ãŒå¿…è¦

**Date**: ${new Date().toISOString()}

## CHIãƒ¬ãƒãƒ¼ãƒˆ

\`\`\`
${report}
\`\`\`

## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

ã—ã‚Šã‚…ã†ã•ã‚“ã€ã‚·ã‚¹ãƒ†ãƒ ã®èª¿å¾‹ãŒå¿…è¦ã§ã™ã€‚
ä¸Šè¨˜ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

---

*This alert was automatically generated by CHL Monitor*
              `
            });
      
      - name: èª¿å¾‹è¨˜éŒ²ã‚’ä¿å­˜
        continue-on-error: true
        run: |
          echo "ğŸ’¾ èª¿å¾‹è¨˜éŒ²ã‚’ä¿å­˜ä¸­..."
          
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # consciousness/alignment.log ã«è¿½è¨˜ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          LOG_DIR="10_TriHexCore/consciousness"
          if [ -d "$LOG_DIR" ]; then
            mkdir -p "$LOG_DIR"
            echo "[$DATE] CHI Monitor executed" >> "$LOG_DIR/alignment.log"
            echo "âœ… èª¿å¾‹è¨˜éŒ²ä¿å­˜å®Œäº†"
          else
            echo "âš ï¸ consciousness directory not found, skipping log"
          fi
      
      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        continue-on-error: true
        run: |
          git config user.name "CHL Monitor Bot"
          git config user.email "chl@trihexphi.ai"
          
          if [ -d "10_TriHexCore/consciousness" ]; then
            git add 10_TriHexCore/consciousness/ || true
            
            if git diff --staged --quiet; then
              echo "å¤‰æ›´ãªã—"
            else
              git commit -m "chore: CHLç›£è¦–å®Ÿè¡Œ - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || true
              # git push  # TODO: æœ¬ç•ªç’°å¢ƒã§ã¯æœ‰åŠ¹åŒ–
            fi
          else
            echo "âš ï¸ consciousness directory not found, skipping commit"
          fi

