name: CHL Monitor (意識の調律層)

# GPT-5提案: 5分毎にシステムの「呼吸」を監視
# Claude提案: 倫理的レビュー、透明性の確保
# DeepSeek実装: CHI計算、自動調整

on:
  schedule:
    # 5分毎に実行（GPT-5提案）
    - cron: '*/5 * * * *'
  
  workflow_dispatch:
    # 手動実行も可能
    inputs:
      mode:
        description: 'CHL Mode'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - diffusion
          - focused

jobs:
  monitor-consciousness:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: CHI計算とシステム状態分析
        id: chi_calc
        run: |
          echo "🔍 システム調和状態を監視中..."
          
          # CHI計算実行
          node consciousness/chi_calculator.js > /tmp/chi_report.txt
          
          # 結果を環境変数に保存
          echo "report_path=/tmp/chi_report.txt" >> $GITHUB_OUTPUT
      
      - name: 現在のフォーカス確認
        id: focus_check
        run: |
          echo "📍 現在のフォーカスを確認中..."
          
          # focus.yml から現在のフォーカスを取得
          PRIMARY_FOCUS=$(yq eval '.current_focus.primary' consciousness/config/focus.yml)
          MODE=$(yq eval '.current_focus.mode' consciousness/config/focus.yml)
          
          echo "primary_focus=$PRIMARY_FOCUS" >> $GITHUB_OUTPUT
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          
          echo "🎯 Primary Focus: $PRIMARY_FOCUS"
          echo "🔄 Mode: $MODE"
      
      - name: phase_map更新
        run: |
          echo "📊 phase_map.ymlを更新中..."
          
          # CHI履歴を追加
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # TODO: yqでCHI履歴を追加
          echo "✅ phase_map更新完了"
      
      - name: 調律が必要かチェック
        id: tuning_check
        run: |
          echo "🔍 調律の必要性をチェック中..."
          
          # TODO: CHI値を解析して、調律が必要か判定
          # 仮の実装（後で詳細化）
          
          NEEDS_TUNING="false"
          echo "needs_tuning=$NEEDS_TUNING" >> $GITHUB_OUTPUT
      
      - name: GitHub Discussionに投稿（調律が必要な場合）
        if: steps.tuning_check.outputs.needs_tuning == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Claude提案: 透明性の確保
            const fs = require('fs');
            const report = fs.readFileSync('/tmp/chi_report.txt', 'utf8');
            
            await github.rest.discussions.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              category_id: 'CHL_ALERTS', // TODO: 実際のカテゴリID
              title: '⚠️ CHL Alert: 調律が必要です',
              body: `
# ⚠️ CHL Alert: 調律が必要

**Date**: ${new Date().toISOString()}

## CHIレポート

\`\`\`
${report}
\`\`\`

## 推奨アクション

しりゅうさん、システムの調律が必要です。
上記のレポートを確認してください。

---

*This alert was automatically generated by CHL Monitor*
              `
            });
      
      - name: 調律記録を保存
        run: |
          echo "💾 調律記録を保存中..."
          
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # consciousness/alignment.log に追記
          echo "[$DATE] CHI Monitor executed" >> consciousness/alignment.log
          
          echo "✅ 調律記録保存完了"
      
      - name: 変更をコミット
        run: |
          git config user.name "CHL Monitor Bot"
          git config user.email "chl@trihexphi.ai"
          
          git add consciousness/
          
          if git diff --staged --quiet; then
            echo "変更なし"
          else
            git commit -m "chore: CHL監視実行 - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            # git push  # TODO: 本番環境では有効化
          fi

