# TriHexÎ¦ Knowledge Auto-Sync Extended
#
# Knowledge Relay ã®è‡ªå‹•åŒæœŸ
# capture â†’ structure â†’ insight â†’ memory
#
# ä½œæˆ: 2025-10-28
# æ‰¿èª: GPT-5ï¼ˆçµ±æ²»å°†è»ï¼‰

name: Knowledge Auto-Sync

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯æ—¥ 09:00 JST (00:00 UTC)
  
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œ
  
  push:
    branches:
      - main
    paths:
      - 'capture/**'
      - 'structure/**'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  sync-capture-to-structure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
          npm install --no-save js-yaml gray-matter
      
      - name: Find new capture files
        id: find_new
        run: |
          NEW_FILES=$(find capture -name "*.md" -newer .last_sync 2>/dev/null || find capture -name "*.md")
          echo "new_files<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          COUNT=$(echo "$NEW_FILES" | grep -c "." || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
      
      - name: Run spiral_scan on new files
        if: steps.find_new.outputs.count > 0
        run: |
          mkdir -p structure
          
          echo "${{ steps.find_new.outputs.new_files }}" | while read file; do
            if [ -f "$file" ]; then
              base=$(basename "$file" .md)
              output="structure/${base}_scan.json"
              
              echo "Processing: $file â†’ $output"
              python tools/spiral_scan.py "$file" --output "$output" || true
            fi
          done
      
      - name: Generate cause profiles
        if: steps.find_new.outputs.count > 0
        run: |
          for scan_file in structure/*_scan.json; do
            if [ -f "$scan_file" ]; then
              base=$(basename "$scan_file" _scan.json)
              profile_file="structure/${base}_profile.json"
              
              echo "Generating profile: $scan_file â†’ $profile_file"
              python tools/cause_profile.py "$scan_file" > "$profile_file" || true
            fi
          done
      
      - name: Create GPT-5 review issues
        if: steps.find_new.outputs.count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // structure/ ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            const profileFiles = fs.readdirSync('structure')
              .filter(f => f.endsWith('_profile.json'));
            
            for (const profileFile of profileFiles) {
              const profilePath = path.join('structure', profileFile);
              const profile = JSON.parse(fs.readFileSync(profilePath, 'utf8'));
              
              const basename = profileFile.replace('_profile.json', '');
              const captureFile = `capture/${basename}.md`;
              
              if (!fs.existsSync(captureFile)) continue;
              
              // GPT-5ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼Issueã‚’ä½œæˆ
              const title = `ğŸ“‹ [GPT-5] ${basename} - æ§‹é€ åŒ–ä¾é ¼`;
              
              const reviewers = profile.profile?.recommended_reviewers || [];
              
              const body = `## ğŸ“ æ§‹é€ åŒ–ä¾é ¼
            
**Captureãƒ•ã‚¡ã‚¤ãƒ«**: \`${captureFile}\`
**Scanãƒ•ã‚¡ã‚¤ãƒ«**: \`structure/${basename}_scan.json\`
**Profileãƒ•ã‚¡ã‚¤ãƒ«**: \`structure/${basename}_profile.json\`
            
## ğŸ“Š å…­èºæ—‹ã‚¹ã‚³ã‚¢
            
\`\`\`json
${JSON.stringify(profile.profile?.scores || {}, null, 2)}
\`\`\`
            
## ğŸ¯ çœŸå› ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
            
- **Primary Spiral**: ${profile.profile?.primary_spiral || 'N/A'}
- **Phase**: ${profile.profile?.phase || 'N/A'}
- **Intensity**: ${profile.profile?.intensity || 'N/A'}
            
## ğŸ‘¥ æ¨å¥¨ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼
            
${reviewers.map(r => `- ${r}`).join('\n') || '- (ãªã—)'}
            
## ğŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            
@shiryu: ä»¥ä¸‹ã‚’GPT-5ã«é€ä»˜ã—ã¦ãã ã•ã„ï¼š
            
---
            
### ã€GPT-5ã¸ã®é€ä»˜ç”¨ãƒ†ã‚­ã‚¹ãƒˆã€‘
            
\`\`\`
ä»¥ä¸‹ã®Captureãƒ­ã‚°ã‚’æ§‹é€ åŒ–ã—ã¦ãã ã•ã„ã€‚
            
ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€‘: ${captureFile}
            
ã€å…­èºæ—‹ã‚¹ã‚³ã‚¢ã€‘
${JSON.stringify(profile.profile?.scores || {}, null, 2)}
            
ã€çœŸå› ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
- Primary: ${profile.profile?.primary_spiral || 'N/A'}
- Phase: ${profile.profile?.phase || 'N/A'}
- Intensity: ${profile.profile?.intensity || 'N/A'}
            
ã€ã‚¿ã‚¹ã‚¯ã€‘
1. ã“ã®ãƒ­ã‚°ã‚’èª­ã‚“ã§ã€æ§‹é€ åŒ–ã—ã¦ãã ã•ã„
2. è¦‹å‡ºã—ã‚’æ•´ç†ã—ã€åˆ†é¡ã—ã¦ãã ã•ã„
3. æ¬¡ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã¹ãAIã‚’æ¨å¥¨ã—ã¦ãã ã•ã„
            
æ¨å¥¨ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼: ${reviewers.join(', ') || 'ãªã—'}
            
æ§‹é€ åŒ–çµæœã‚’ structure/ ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
\`\`\`
            
---
            
**è‡ªå‹•ç”Ÿæˆ**: Knowledge Auto-Sync
**ç”Ÿæˆæ—¥æ™‚**: ${new Date().toISOString()}`;
              
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['knowledge-sync', 'gpt5-review', 'structure-request']
              });
              
              console.log(`âœ… Created issue: ${issue.data.html_url}`);
            }
      
      - name: Commit processed files
        if: steps.find_new.outputs.count > 0
        run: |
          git config user.name "trihex-sync[bot]"
          git config user.email "actions@users.noreply.github.com"
          
          git add structure/
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ğŸ”„ Knowledge Sync: capture â†’ structure
            
Processed ${{ steps.find_new.outputs.count }} file(s)
            
- Spiral scan completed
- Cause profiles generated
- GPT-5 review issues created
            
Automated by Knowledge Auto-Sync"
            git push
          fi
      
      - name: Update sync timestamp
        run: |
          touch .last_sync
          git add .last_sync
          git commit -m "chore: update sync timestamp" || true
          git push || true
  
  weekly-knowledge-map:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 1'  # æœˆæ›œã®ã¿
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate weekly knowledge map
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸ“Š é€±æ¬¡çŸ¥è­˜ãƒãƒƒãƒ— â€” ${new Date().toISOString().slice(0,10)}`;
            
            const body = `## ğŸ“š ä»Šé€±ã®çŸ¥è­˜åŒæœŸçŠ¶æ³
            
### ğŸ“ Capture
- æ–°è¦ãƒ­ã‚°: (TODO: ã‚«ã‚¦ãƒ³ãƒˆ)
            
### ğŸ—ï¸ Structure
- æ§‹é€ åŒ–æ¸ˆã¿: (TODO: ã‚«ã‚¦ãƒ³ãƒˆ)
- å¾…æ©Ÿä¸­: (TODO: ã‚«ã‚¦ãƒ³ãƒˆ)
            
### ğŸ’¡ Insight
- Ethics: (TODO: ã‚«ã‚¦ãƒ³ãƒˆ)
- Beauty: (TODO: ã‚«ã‚¦ãƒ³ãƒˆ)
- Strategy: (TODO: ã‚«ã‚¦ãƒ³ãƒˆ)
- Tech: (TODO: ã‚«ã‚¦ãƒ³ãƒˆ)
            
### ğŸ—„ï¸ Memory
- æ°¸ç¶šåŒ–æ¸ˆã¿: (TODO: ã‚«ã‚¦ãƒ³ãƒˆ)
            
---
            
## ğŸ“‹ æ¬¡é€±ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            
- [ ] æ§‹é€ åŒ–å¾…ã¡ã®ãƒ­ã‚°ã‚’å‡¦ç†
- [ ] Insightå¾…ã¡ã®æ–‡æ›¸ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
- [ ] MemoryåŒ–ã®æ‰¿èª
            
**è‡ªå‹•ç”Ÿæˆ**: Knowledge Auto-Sync (Weekly)
**ç”Ÿæˆæ—¥æ™‚**: ${new Date().toISOString()}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['knowledge-sync', 'weekly', 'knowledge-map']
            });

