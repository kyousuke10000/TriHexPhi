name: AI Triage (on workflow failure)

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]

jobs:
  triage:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm i @anthropic-ai/sdk @google/generative-ai

      - name: Fetch logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: node tools/ci/fetch-run-log.mjs

      - name: Ask Claude (patch)
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_MODEL: claude-3-5-sonnet
        run: |
          FILE=$(node tools/ci/ask-claude.mjs)
          echo "FILE=$FILE" >> $GITHUB_OUTPUT
          echo "Claude patch: $FILE"

      - name: Ask Gemini (plan)
        id: gemini
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GEMINI_MODEL: gemini-1.5-pro
        run: |
          FILE=$(node tools/ci/ask-gemini.mjs)
          echo "FILE=$FILE" >> $GITHUB_OUTPUT
          echo "Gemini plan: $FILE"

      - name: Commit Proofs
        run: |
          git config user.name "s3-bot"
          git config user.email "actions@users.noreply.github.com"
          git add 99_SYSTEM/Proofs/CI .logs/
          if ! git diff --cached --quiet; then
            git commit -m "ci: triage proofs (auto) [skip ci]"
            git push
          fi

      - name: Comment to PR
        if: ${{ github.event.workflow_run.pull_requests && github.event.workflow_run.pull_requests.length > 0 }}
        uses: thollander/actions-comment-pull-request@v2
        with:
          pr_number: ${{ github.event.workflow_run.pull_requests[0].number }}
          message: |
            ### ğŸ¤– CI Triage (Auto)
            
            **å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: `${{ github.event.workflow_run.name }}`
            **Run ID**: `${{ github.event.workflow_run.id }}`
            
            - **Claude Patch**: `${{ steps.claude.outputs.FILE }}`
            - **Gemini Plan**: `${{ steps.gemini.outputs.FILE }}`
            
            å¤±æ•—ãƒ­ã‚°ã¯ `.logs/last.log` ã‚’å‚ç…§ã€‚æœ€å°å·®åˆ†ã§ã®ä¿®æ­£ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

      - name: Open Issue when no PR
        if: ${{ !github.event.workflow_run.pull_requests || github.event.workflow_run.pull_requests.length == 0 }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "CI failure: ${{ github.event.workflow_run.name }}" \
            --body "**å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: \`${{ github.event.workflow_run.name }}\`
          **Run ID**: \`${{ github.event.workflow_run.id }}\`
          **çµè«–**: \`${{ github.event.workflow_run.conclusion }}\`
          
          - **Claude Patch**: \`${{ steps.claude.outputs.FILE }}\`
          - **Gemini Plan**: \`${{ steps.gemini.outputs.FILE }}\`
          
          å¤±æ•—ãƒ­ã‚°ã¯ \`.logs/last.log\` ã‚’å‚ç…§ã€‚æœ€å°å·®åˆ†ã§ã®ä¿®æ­£ã‚’æ¨å¥¨ã—ã¾ã™ã€‚" \
            --label "ci:fix" || echo "Issue creation failed (may already exist)"

