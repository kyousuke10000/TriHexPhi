name: AI Triage (on workflow failure)

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: "Target workflow_run.id to triage"
        required: false
        type: string

jobs:
  triage:
    if: >
      ${{
        (github.event_name == 'workflow_dispatch') ||
        (github.event.workflow_run.conclusion != 'success' &&
         github.event.workflow_run.name != 'AI Triage (on workflow failure)')
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm i @anthropic-ai/sdk @google/generative-ai

      - name: Set RUN_ID
        run: |
          RUN_ID="${{ github.event.inputs.run_id || github.event.workflow_run.id }}"
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Using RUN_ID: $RUN_ID"

      - name: Fetch logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$RUN_ID" ]; then
            echo "âš ï¸ RUN_ID not provided. Skipping log fetch."
            mkdir -p .logs
            echo "No log available (manual dispatch without run_id)" > .logs/last.log
          else
            node tools/ci/fetch-run-log.mjs
          fi

      - name: Ask Claude (patch)
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_MODEL: claude-3-5-sonnet
        run: |
          FILE=$(node tools/ci/ask-claude.mjs)
          echo "FILE=$FILE" >> $GITHUB_OUTPUT
          echo "Claude patch: $FILE"

      - name: Ask Gemini (plan)
        id: gemini
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GEMINI_MODEL: gemini-1.5-pro
        run: |
          FILE=$(node tools/ci/ask-gemini.mjs)
          echo "FILE=$FILE" >> $GITHUB_OUTPUT
          echo "Gemini plan: $FILE"

      - name: Commit Proofs
        run: |
          git config user.name "s3-bot"
          git config user.email "actions@users.noreply.github.com"
          git add 99_SYSTEM/Proofs/CI .logs/
          if ! git diff --cached --quiet; then
            git commit -m "ci: triage proofs (auto) [skip ci]"
            git push
          fi

      - name: Get PR number and create comment/issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = context.payload.workflow_run?.name || 'Unknown workflow';
            const runId = context.payload.workflow_run?.id || context.payload.inputs?.run_id || 'N/A';
            const conclusion = context.payload.workflow_run?.conclusion || 'N/A';
            const headBranch = context.payload.workflow_run?.head_branch;
            const claudeFile = '${{ steps.claude.outputs.FILE }}';
            const geminiFile = '${{ steps.gemini.outputs.FILE }}';
            
            const message = `### ğŸ¤– CI Triage (Auto)
            
            **å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: \`${workflowName}\`
            **Run ID**: \`${runId}\`
            
            - **Claude Patch**: \`${claudeFile}\`
            - **Gemini Plan**: \`${geminiFile}\`
            
            å¤±æ•—ãƒ­ã‚°ã¯ \`.logs/last.log\` ã‚’å‚ç…§ã€‚æœ€å°å·®åˆ†ã§ã®ä¿®æ­£ã‚’æ¨å¥¨ã—ã¾ã™ã€‚`;
            
            // PRã‚’æ¤œç´¢
            let prNumber = null;
            if (headBranch) {
              try {
                const { data: prs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  head: `${context.repo.owner}:${headBranch}`
                });
                if (prs.length > 0) {
                  prNumber = prs[0].number;
                }
              } catch (error) {
                console.log('Error finding PR:', error.message);
              }
            }
            
            // PRãŒã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã€ãªã‘ã‚Œã°Issueä½œæˆ
            if (prNumber) {
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: message
                });
                console.log(`âœ… Commented on PR #${prNumber}`);
              } catch (error) {
                console.log('Error commenting on PR:', error.message);
              }
            } else {
              try {
                const issueBody = `**å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: \`${workflowName}\`
                **Run ID**: \`${runId}\`
                **çµè«–**: \`${conclusion}\`
                
                - **Claude Patch**: \`${claudeFile}\`
                - **Gemini Plan**: \`${geminiFile}\`
                
                å¤±æ•—ãƒ­ã‚°ã¯ \`.logs/last.log\` ã‚’å‚ç…§ã€‚æœ€å°å·®åˆ†ã§ã®ä¿®æ­£ã‚’æ¨å¥¨ã—ã¾ã™ã€‚`;
                
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `CI failure: ${workflowName}`,
                  body: issueBody,
                  labels: ['ci:fix']
                });
                console.log('âœ… Issue created successfully');
              } catch (error) {
                console.log('âš ï¸ Issue creation failed (may already exist):', error.message);
              }
            }
