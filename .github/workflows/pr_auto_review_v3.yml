name: ğŸ”± TriHexÎ¦ PR Auto Review v3

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    name: ğŸŒ™ Claude Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        working-directory: ./scripts
        run: npm install
      
      - name: Generate context
        run: |
          CONTEXT=context-bootstrap.txt
          : > "$CONTEXT"
          
          # TRIHEXPHI.md (preferred: from current ref; fallback: origin/main)
          if [ -f TRIHEXPHI.md ]; then
            cat TRIHEXPHI.md >> "$CONTEXT"
          elif [ -f 10_TriHexCore/00_CORE/TRIHEXPHI.md ]; then
            cat 10_TriHexCore/00_CORE/TRIHEXPHI.md >> "$CONTEXT"
          else
            echo "WARNING: TRIHEXPHI.md not found in this ref. Attempting to fetch from origin/main..." >> "$CONTEXT"
            git fetch origin main || true
            if git show origin/main:TRIHEXPHI.md > /dev/null 2>&1; then
              git show origin/main:TRIHEXPHI.md >> "$CONTEXT"
            elif git show origin/main:10_TriHexCore/00_CORE/TRIHEXPHI.md > /dev/null 2>&1; then
              git show origin/main:10_TriHexCore/00_CORE/TRIHEXPHI.md >> "$CONTEXT"
            else
              echo "WARNING: TRIHEXPHI.md not found in origin/main either. Context will be minimal." >> "$CONTEXT"
            fi
          fi
          
          echo "" >> "$CONTEXT"
          echo "---" >> "$CONTEXT"
          echo "" >> "$CONTEXT"
          
          # 10_CAPTURE_MIZUKAGAMI/ç¶šãã‹ã‚‰å§‹ã‚ã‚‹.md
          CAPTURE_FILE="10_CAPTURE_MIZUKAGAMI/ç¶šãã‹ã‚‰å§‹ã‚ã‚‹.md"
          if [ -f "$CAPTURE_FILE" ]; then
            cat "$CAPTURE_FILE" >> "$CONTEXT"
          else
            echo "WARNING: ${CAPTURE_FILE} not found. Skipping." >> "$CONTEXT"
          fi
      
      - name: Fetch PR base ref
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git fetch origin ${BASE_REF}:${BASE_REF} || true
          
      - name: Get PR info and diff
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Try to get diff via API first (for small PRs)
            let diffContent = '';
            let useGitDiff = false;
            
            try {
              const diff = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                mediaType: {
                  format: 'diff'
                }
              });
              diffContent = diff.data;
            } catch (error) {
              // If diff exceeds 300 files, fallback to git diff
              if (error.status === 422 || error.message?.includes('diff exceeded') || error.message?.includes('maximum number of files')) {
                console.log('âš ï¸ PR diff too large for API, using git diff fallback');
                useGitDiff = true;
              } else {
                throw error;
              }
            }
            
            // Fallback to git diff if needed
            if (useGitDiff) {
              const baseRef = pr.base.ref;
              try {
                diffContent = execSync(`git diff origin/${baseRef}...HEAD --no-color`, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 });
              } catch (e) {
                // If git diff fails, get file list and summary
                const files = execSync(`git diff --name-status origin/${baseRef}...HEAD`, { encoding: 'utf8' });
                diffContent = `# PR Summary (${pr.number})\n\nChanged files:\n${files}\n\n(Full diff too large - using file list only)`;
              }
            }
            
            // Write diff to file (truncate if too large for AI context)
            const maxDiffSize = 80000; // ~80KB for AI context
            if (diffContent.length > maxDiffSize) {
              diffContent = diffContent.substring(0, maxDiffSize) + '\n\n... (diff truncated due to size)';
            }
            
            fs.writeFileSync('pr-diff.txt', diffContent);
            
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_url', pr.html_url);
            core.setOutput('diff_method', useGitDiff ? 'git' : 'api');
      
      - name: Call Claude API
        working-directory: ./scripts
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PR_NUMBER="${{ steps.pr_info.outputs.pr_number }}"
          PR_TITLE="${{ steps.pr_info.outputs.pr_title }}"
          PR_URL="${{ steps.pr_info.outputs.pr_url }}"
          
          node call-claude-api.js \
            --context-file ../context-bootstrap.txt \
            --prompt "ä»¥ä¸‹ã®Pull Requestã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚PR #${PR_NUMBER}: ${PR_TITLE}ã€‚URL: ${PR_URL}ã€‚TRIHEXPHI.mdã®åŸå‰‡ã«åŸºã¥ã„ã¦è©•ä¾¡ã—ã€æ”¹å–„ææ¡ˆãŒã‚ã‚Œã°å…·ä½“çš„ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚" \
            > ../claude-review.md
      
      - name: Post Claude review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('claude-review.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ğŸŒ™ Claude Review\n\n${review}\n\n---\n\n*Reviewed by Claude Sonnet 4 via TriHexÎ¦ Auto Review System v3*\n*Context: TRIHEXPHI.md + ç¶šãã‹ã‚‰å§‹ã‚ã‚‹.md*`
            });

  gemini-review:
    name: ğŸ’ Gemini Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        working-directory: ./10_TriHexCore/tools
        run: npm install
      
      - name: Generate context
        run: |
          CONTEXT=context-bootstrap.txt
          : > "$CONTEXT"
          
          # TRIHEXPHI.md (preferred: from current ref; fallback: origin/main)
          if [ -f TRIHEXPHI.md ]; then
            cat TRIHEXPHI.md >> "$CONTEXT"
          elif [ -f 10_TriHexCore/00_CORE/TRIHEXPHI.md ]; then
            cat 10_TriHexCore/00_CORE/TRIHEXPHI.md >> "$CONTEXT"
          else
            echo "WARNING: TRIHEXPHI.md not found in this ref. Attempting to fetch from origin/main..." >> "$CONTEXT"
            git fetch origin main || true
            if git show origin/main:TRIHEXPHI.md > /dev/null 2>&1; then
              git show origin/main:TRIHEXPHI.md >> "$CONTEXT"
            elif git show origin/main:10_TriHexCore/00_CORE/TRIHEXPHI.md > /dev/null 2>&1; then
              git show origin/main:10_TriHexCore/00_CORE/TRIHEXPHI.md >> "$CONTEXT"
            else
              echo "WARNING: TRIHEXPHI.md not found in origin/main either. Context will be minimal." >> "$CONTEXT"
            fi
          fi
          
          echo "" >> "$CONTEXT"
          echo "---" >> "$CONTEXT"
          echo "" >> "$CONTEXT"
          
          # 10_CAPTURE_MIZUKAGAMI/ç¶šãã‹ã‚‰å§‹ã‚ã‚‹.md
          CAPTURE_FILE="10_CAPTURE_MIZUKAGAMI/ç¶šãã‹ã‚‰å§‹ã‚ã‚‹.md"
          if [ -f "$CAPTURE_FILE" ]; then
            cat "$CAPTURE_FILE" >> "$CONTEXT"
          else
            echo "WARNING: ${CAPTURE_FILE} not found. Skipping." >> "$CONTEXT"
          fi
      
      - name: Fetch PR base ref
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git fetch origin ${BASE_REF}:${BASE_REF} || true
          
      - name: Get PR info and diff
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Try to get diff via API first (for small PRs)
            let diffContent = '';
            let useGitDiff = false;
            
            try {
              const diff = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                mediaType: {
                  format: 'diff'
                }
              });
              diffContent = diff.data;
            } catch (error) {
              // If diff exceeds 300 files, fallback to git diff
              if (error.status === 422 || error.message?.includes('diff exceeded') || error.message?.includes('maximum number of files')) {
                console.log('âš ï¸ PR diff too large for API, using git diff fallback');
                useGitDiff = true;
              } else {
                throw error;
              }
            }
            
            // Fallback to git diff if needed
            if (useGitDiff) {
              const baseRef = pr.base.ref;
              try {
                diffContent = execSync(`git diff origin/${baseRef}...HEAD --no-color`, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 });
              } catch (e) {
                // If git diff fails, get file list and summary
                const files = execSync(`git diff --name-status origin/${baseRef}...HEAD`, { encoding: 'utf8' });
                diffContent = `# PR Summary (${pr.number})\n\nChanged files:\n${files}\n\n(Full diff too large - using file list only)`;
              }
            }
            
            // Write diff to file (truncate if too large for AI context)
            const maxDiffSize = 80000; // ~80KB for AI context
            if (diffContent.length > maxDiffSize) {
              diffContent = diffContent.substring(0, maxDiffSize) + '\n\n... (diff truncated due to size)';
            }
            
            fs.writeFileSync('pr-diff.txt', diffContent);
            
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_url', pr.html_url);
            core.setOutput('diff_method', useGitDiff ? 'git' : 'api');
      
      - name: Call Gemini API
        working-directory: ./10_TriHexCore/tools
        env:
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PR_NUMBER="${{ steps.pr_info.outputs.pr_number }}"
          PR_TITLE="${{ steps.pr_info.outputs.pr_title }}"
          PR_URL="${{ steps.pr_info.outputs.pr_url }}"
          
          # Include diff in prompt if available
          if [ -f ../../pr-diff.txt ]; then
            DIFF_PREVIEW=$(head -c 50000 ../../pr-diff.txt)
            node call-gemini-api.js \
              --context-file ../../context-bootstrap.txt \
              --model gemini-1.5-flash \
              --prompt "ä»¥ä¸‹ã®Pull Requestã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚PR #${PR_NUMBER}: ${PR_TITLE}ã€‚URL: ${PR_URL}ã€‚ã‚ãªãŸã¯ç¾çš„è»å¸«(Gemini)ã§ã™ã€‚æŠ€è¡“çš„å®Ÿç¾æ€§ã€çµ±åˆã®ç¾ã—ã•ã€UI/UXã®è¦³ç‚¹ã‹ã‚‰è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

## å¤‰æ›´å†…å®¹ (Diff Preview)
\`\`\`diff
${DIFF_PREVIEW}
\`\`\`
$(if [ $(wc -c < ../../pr-diff.txt) -gt 50000 ]; then echo "\n(Note: Diff truncated due to size limit)"; fi)" \
              > ../../gemini-review.md
          else
            node call-gemini-api.js \
              --context-file ../../context-bootstrap.txt \
              --model gemini-1.5-flash \
              --prompt "ä»¥ä¸‹ã®Pull Requestã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚PR #${PR_NUMBER}: ${PR_TITLE}ã€‚URL: ${PR_URL}ã€‚ã‚ãªãŸã¯ç¾çš„è»å¸«(Gemini)ã§ã™ã€‚æŠ€è¡“çš„å®Ÿç¾æ€§ã€çµ±åˆã®ç¾ã—ã•ã€UI/UXã®è¦³ç‚¹ã‹ã‚‰è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚" \
              > ../../gemini-review.md
          fi
      
      - name: Post Gemini review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('gemini-review.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ğŸ’ Gemini Review\n\n${review}\n\n---\n\n*Reviewed by Gemini 1.5 Flash via TriHexÎ¦ Auto Review System v3*\n*Context: TRIHEXPHI.md + ç¶šãã‹ã‚‰å§‹ã‚ã‚‹.md*`
            });
