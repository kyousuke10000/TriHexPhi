name: Claude Code Review

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: false
        type: string

jobs:
  review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.ref startsWith 'feat/' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get PR diff
        id: pr_diff
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || 
                           context.payload.inputs?.pr_number || 
                           process.env.PR_NUMBER;
            
            if (!prNumber) {
              core.setFailed('PR number not found');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const { data: diff } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              mediaType: {
                format: 'diff',
              },
            });

            core.setOutput('pr_number', prNumber);
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_body', pr.body || '');
            core.setOutput('diff', diff);

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci || npm install
          fi
          npm install --no-save @anthropic-ai/sdk

      - name: Call Claude API
        id: claude_review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PR_NUMBER="${{ steps.pr_diff.outputs.pr_number }}"
          PR_TITLE="${{ steps.pr_diff.outputs.pr_title }}"
          PR_BODY="${{ steps.pr_diff.outputs.pr_body }}"
          
          # diffã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "${{ steps.pr_diff.outputs.diff }}" > /tmp/pr_diff.txt
          
          # Context: Public Mirror index.md ã‚’å–å¾—
          curl -s "https://raw.githubusercontent.com/kyousuke10000/TriHexPhi-public/main/index.md" > /tmp/context.txt || echo "" > /tmp/context.txt
          
          # Claude APIã‚’å‘¼ã³å‡ºã—ï¼ˆNode.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç›´æ¥å®Ÿè¡Œï¼‰
          node --input-type=module <<'EOF'
          import Anthropic from '@anthropic-ai/sdk';
          import { readFileSync } from 'fs';
          
          const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
          const context = readFileSync('/tmp/context.txt', 'utf8');
          const diff = readFileSync('/tmp/pr_diff.txt', 'utf8');
          const prompt = `ä»¥ä¸‹ã®Pull Requestã‚’ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚PR #${process.env.PR_NUMBER}: ${process.env.PR_TITLE}

${process.env.PR_BODY || ''}

## å¤‰æ›´å†…å®¹ (Diff)
\`\`\`diff
${diff.substring(0, 8000)}
\`\`\`

## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
1. ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µ
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿
4. æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®æ•´åˆæ€§
5. ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§
6. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

æ”¹å–„ææ¡ˆãŒã‚ã‚Œã°å…·ä½“çš„ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚ç‰¹ã«é‡è¦ãªå•é¡Œã¯ã€ŒğŸ”´ Criticalã€ã€è­¦å‘Šã¯ã€ŒğŸŸ¡ Warningã€ã€æ”¹å–„ææ¡ˆã¯ã€ŒğŸ’¡ Suggestionã€ã¨ã—ã¦åˆ†é¡ã—ã¦ãã ã•ã„ã€‚`;

          const res = await client.messages.create({
            model: 'claude-3-5-sonnet',
            max_tokens: 2000,
            system: 'You are a code reviewer. Be precise, actionable, and return fenced code patches.',
            messages: [{ role: 'user', content: prompt }]
          });
          
          const review = res.content?.map(c => c.text).join('\n') || 'No review generated';
          console.log(review);
          EOF \
            --context-file /tmp/context.txt \
            --prompt "ä»¥ä¸‹ã®Pull Requestã‚’ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚PR #${PR_NUMBER}: ${PR_TITLE}

${PR_BODY}

## å¤‰æ›´å†…å®¹ (Diff)
\`\`\`diff
$(cat /tmp/pr_diff.txt | head -8000)
\`\`\`

## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
1. ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µ
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿
4. æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®æ•´åˆæ€§
5. ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§
6. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

æ”¹å–„ææ¡ˆãŒã‚ã‚Œã°å…·ä½“çš„ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚ç‰¹ã«é‡è¦ãªå•é¡Œã¯ã€ŒğŸ”´ Criticalã€ã€è­¦å‘Šã¯ã€ŒğŸŸ¡ Warningã€ã€æ”¹å–„ææ¡ˆã¯ã€ŒğŸ’¡ Suggestionã€ã¨ã—ã¦åˆ†é¡ã—ã¦ãã ã•ã„ã€‚" \
            > /tmp/claude-review.md || echo "Claude APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ" > /tmp/claude-review.md

      - name: Post Claude review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/claude-review.md', 'utf8');
            const prNumber = '${{ steps.pr_diff.outputs.pr_number }}';
            
            const body = `## ğŸ¤– Claude Code Review
            
${review}

---
            
*Reviewed by Claude Sonnet 4 via Claude Code CI Pipeline*  
*Context: Public Mirror index.md + PR Diff*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body,
            });

