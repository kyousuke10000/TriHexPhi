name: Mirror Gate (Public Mirror)
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (true/false)'
        required: false
        default: 'true'
  push:
    branches: [ main ]
    paths:
      - "99_SYSTEM/Proofs/**"
      - "00_RYUDO/Council/Records/**"
      - "00_RYUDO/Council/Decisions/**"
      - "99_SYSTEM/Proofs/Harmonia/**"
      - "99_SYSTEM/Proofs/Overdrive/**"
      - "context/**"
      - ".github/workflows/mirror_gate_dispatch.yml"

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      MIRROR_REPO: ${{ secrets.MIRROR_REPO }}
      MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
      DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate public index.md
        run: |
          node scripts/generate-public-index.mjs index.md
          echo "âœ… Generated index.md"
          cat index.md | head -20
      
      - name: Build mirror tree
        run: |
          mkdir -p mirror
          rsync -av --prune-empty-dirs \
            --include="99_SYSTEM/" \
            --include="99_SYSTEM/Proofs/" \
            --include="99_SYSTEM/Proofs/**" \
            --include="99_SYSTEM/Proofs/Harmonia/" \
            --include="99_SYSTEM/Proofs/Harmonia/**" \
            --include="99_SYSTEM/Proofs/Overdrive/" \
            --include="99_SYSTEM/Proofs/Overdrive/**" \
            --include="00_RYUDO/" \
            --include="00_RYUDO/Council/" \
            --include="00_RYUDO/Council/Decisions/" \
            --include="00_RYUDO/Council/Decisions/**" \
            --include="00_RYUDO/Council/Records/" \
            --include="00_RYUDO/Council/Records/**" \
            --include="README.md" \
            --include="docs/" \
            --include="docs/index.md" \
            --include="index.md" \
            --exclude="*" \
            ./ mirror/
          echo "=== Files copied to mirror ==="
          find mirror -type f | head -50 || echo "No files found"
      
      - name: Dry-run listing
        if: env.DRY_RUN == 'true'
        run: |
          echo "---- DRY RUN ----"
          find mirror -type f | sort || true
          echo "---- END ----"
      
      - name: Push to Public Mirror
        if: env.DRY_RUN != 'true'
        run: |
          set -e
          git config --global user.name "mirror-bot"
          git config --global user.email "mirror-bot@users.noreply.github.com"
          git clone "https://${MIRROR_TOKEN}@github.com/${MIRROR_REPO}.git" pub
          cd pub
          git rm -r . >/dev/null 2>&1 || true
          cp -R ../mirror/. .
          git add .
          if git diff --cached --quiet; then
            echo "No changes to mirror."
          else
            MSG="chore(mirror): sync from ${GITHUB_REPOSITORY}@${GITHUB_SHA::7}"
            git commit -m "$MSG"
            git push origin HEAD
            echo "âœ… Pushed to ${MIRROR_REPO}"
            echo "ðŸ“Œ Public index: https://github.com/${MIRROR_REPO}/blob/main/index.md"
            echo "ðŸ“Œ Raw index: https://raw.githubusercontent.com/${MIRROR_REPO}/main/index.md"
          fi
