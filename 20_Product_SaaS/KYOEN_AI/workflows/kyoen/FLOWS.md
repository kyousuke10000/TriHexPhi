# KYOEN ワークフロー - ノード構成図

## WF-A: KYOEN_RSVP_Collector

### 目的
`/rsvp list` コマンドまたは「参加者一覧」などのキーワードでイベント一覧と参加状況を表示

### ノード構成

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Webhook (POST)                                              │
│     - Path: /kyoen/rsvp-collector                               │
│     - Response Mode: On Received (即時200)                      │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. Code: LINE署名検証                                           │
│     - x-line-signature チェック                                 │
│     - HMAC-SHA256で検証                                         │
│     - 失敗時は400エラー                                         │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. Code: コマンド検出                                           │
│     - events[0].message.text を抽出                             │
│     - 正規表現: /^\/rsvp\s+(list|一覧|リスト)|^(参加者|出席者)/│
│     - マッチしない場合は終了                                     │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. HTTP Request: Supabase RPC (イベント一覧取得)                │
│     - URL: /rest/v1/rpc/get_event_rsvp_summary                  │
│     - Method: POST                                              │
│     - Body: { days_back: 14, limit_count: 10 }                 │
│     - Headers: apikey, Authorization                            │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. If: データ存在チェック                                       │
│     - 条件: $json.length > 0                                    │
│     - true → 6へ                                               │
│     - false → 10へ（空メッセージ）                              │
└────────────┬────────────────────────────────────────────────────┘
             │ (true)
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. Code: Flex Message生成                                      │
│     - event_list.flex.json 雛形を読み込み                       │
│     - プレースホルダー置換（EVENT_ID, TITLE, DATE, etc.）       │
│     - Carousel形式で最大10件                                    │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. HTTP Request: LINE Reply API                                │
│     - URL: https://api.line.me/v2/bot/message/reply            │
│     - Method: POST                                              │
│     - Body: {                                                   │
│         replyToken: $json.replyToken,                           │
│         messages: [{                                            │
│           type: 'flex',                                         │
│           altText: 'イベント一覧',                              │
│           contents: $json.flexMessage                           │
│         }]                                                      │
│       }                                                         │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. Code: ログ記録                                               │
│     - Obsidianログへ記録                                         │
│     - タイムスタンプ、ユーザーID、イベント件数                    │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
        [終了: 成功]

┌─────────────────────────────────────────────────────────────────┐
│  10. Code: 空メッセージ生成 (If=false の場合)                   │
│     - 「今後2週間のイベントはありません」                        │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  11. HTTP Request: LINE Reply API                               │
│     - 空メッセージを返信                                         │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
        [終了: 空結果]
```

### 参加者詳細表示（Postbackハンドリング）

```
┌─────────────────────────────────────────────────────────────────┐
│  12. Webhook (POST) ※同じWebhook                                │
│     - events[0].type === 'postback'                             │
│     - events[0].postback.data に "action=rsvp_detail" を含む   │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  13. Code: event_id抽出                                         │
│     - postback.data から event_id をパース                      │
│     - 例: "action=rsvp_detail&event_id=xxx-yyy-zzz"            │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  14. HTTP Request: Supabase (イベント情報取得)                   │
│     - URL: /rest/v1/kyoen_events?id=eq.{{event_id}}            │
│     - Method: GET                                               │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  15. HTTP Request: Supabase (参加者取得)                         │
│     - URL: /rest/v1/kyoen_rsvp?event_id=eq.{{event_id}}        │
│     - Method: GET                                               │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  16. Code: Flex Message生成 (rsvp_detail)                       │
│     - rsvp_detail.flex.json 雛形を読み込み                      │
│     - 参加者をステータス別に集計・表示                           │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  17. HTTP Request: LINE Push API                                │
│     - Push形式で送信（replyTokenは期限切れの可能性）            │
└─────────────────────────────────────────────────────────────────┘
```

---

## WF-B: KYOEN_Reminders

### 目的
3種類のリマインダーを自動送信
1. 前日18:00 - 全員へ告知
2. 当日8:00 - 参加者「yes」のみへ最終案内
3. 終了後10分 - 議事ドラフト送信

### ノード構成（3つのトリガー）

#### B-1: 前日18:00リマインダー

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Schedule Trigger                                            │
│     - Cron: 0 18 * * * (毎日18:00 JST)                         │
│     - Timezone: Asia/Tokyo                                      │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. Code: 明日の日付計算                                         │
│     - luxon使用                                                 │
│     - tomorrow = now().plus({days: 1}).startOf('day')          │
│     - tomorrowEnd = tomorrow.endOf('day')                       │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. HTTP Request: Supabase (明日のイベント取得)                  │
│     - URL: /rest/v1/kyoen_events                                │
│     - Query: ?start_at=gte.{tomorrow}&start_at=lt.{tomorrowEnd}│
│     - Method: GET                                               │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. If: イベント存在チェック                                     │
│     - 条件: $json.length > 0                                    │
│     - false → 終了                                             │
└────────────┬────────────────────────────────────────────────────┘
             │ (true)
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. Split Out                                                   │
│     - 配列を個別アイテムに分割                                   │
│     - 各イベントを個別処理                                       │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. HTTP Request: Supabase (参加者取得)                          │
│     - URL: /rest/v1/kyoen_rsvp?event_id=eq.{{event.id}}        │
│     - Method: GET                                               │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. Code: Flex Message生成 (reminder)                           │
│     - reminder.flex.json 雛形使用                               │
│     - reminderType: 'day_before'                                │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. HTTP Request: LINE Push API                                 │
│     - to: groupId (全員)                                        │
│     - Flex Message送信                                          │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  9. If: Push成功チェック                                         │
│     - HTTP Status === 200                                       │
│     - false → 再送キューへ                                      │
└────────────┬────────────────────────────────────────────────────┘
             │ (false)
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  10. HTTP Request: Supabase (再送キュー登録)                     │
│     - kyoen_push_retry テーブルへINSERT                         │
└─────────────────────────────────────────────────────────────────┘
```

#### B-2: 当日8:00リマインダー（参加者のみ）

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Schedule Trigger                                            │
│     - Cron: 0 8 * * * (毎日8:00 JST)                           │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. Code: 本日の日付計算                                         │
│     - today = now().startOf('day')                              │
│     - todayEnd = today.endOf('day')                             │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. HTTP Request: Supabase (本日のイベント取得)                  │
│     - Query: ?start_at=gte.{today}&start_at=lt.{todayEnd}      │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. Split Out (イベント分割)                                     │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. HTTP Request: Supabase (参加者取得)                          │
│     - Query: ?event_id=eq.{id}&status=eq.yes                   │
│     - 「yes」の参加者のみ                                        │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. If: 参加者存在チェック                                       │
│     - 条件: $json.length > 0                                    │
└────────────┬────────────────────────────────────────────────────┘
             │ (true)
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. Split Out (参加者分割)                                       │
│     - 個別に Push送信                                           │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. Code: Flex Message生成 (reminder)                           │
│     - reminderType: 'morning'                                   │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  9. HTTP Request: LINE Push API (個別送信)                       │
│     - to: line_user_id                                          │
└─────────────────────────────────────────────────────────────────┘
```

#### B-3: 終了後10分リマインダー（議事ドラフト）

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Schedule Trigger                                            │
│     - Cron: */10 * * * * (10分ごと)                            │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. Code: 10分前終了イベント検索範囲計算                         │
│     - now = now()                                               │
│     - tenMinutesAgo = now.minus({minutes: 10})                  │
│     - twentyMinutesAgo = now.minus({minutes: 20})               │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. HTTP Request: Supabase (終了したイベント取得)                │
│     - Query: ?end_at=gte.{twentyMin}&end_at=lt.{tenMin}        │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. If: イベント存在チェック                                     │
└────────────┬────────────────────────────────────────────────────┘
             │ (true)
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. Split Out (イベント分割)                                     │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. HTTP Request: Supabase (会話ログ取得)                        │
│     - kyoen_messages テーブル                                   │
│     - Query: ?line_group_id=eq.{groupId}&ts=gte.{start_at}     │
│     - 会話履歴を取得                                            │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. Code: 会話ログ整形                                           │
│     - メッセージを時系列で結合                                   │
│     - LLM要約用テキスト生成                                     │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. HTTP Request: LLM要約 (OpenAI API)                          │
│     - Model: gpt-4o-mini                                        │
│     - Prompt: 「以下の会話を議事録形式で要約してください」       │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  9. Code: 議事録テンプレート整形                                 │
│     - 決定事項 / ToDo / 未解決 / 参考リンク                     │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  10. HTTP Request: Supabase (議事録保存)                         │
│     - kyoen_meetings.summary へUPDATE                           │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  11. Code: Flex Message生成 (reminder)                          │
│     - reminderType: 'after'                                     │
│     - 議事録内容を含む                                          │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  12. HTTP Request: LINE Push API (グループ送信)                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## WF-C: KYOEN_Cards

### 目的
告知カード生成をワンコマンドで実行

### ノード構成

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Webhook (POST)                                              │
│     - Path: /kyoen/cards                                        │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. Code: LINE署名検証                                           │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. Code: コマンド検出                                           │
│     - /^\/card/ または Quick Reply「カード作る」               │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. If: コマンド形式チェック                                     │
│     - パターン1: /card {title}|{when}|{where}|{subtitle}      │
│     - パターン2: Quick Replyから誘導                            │
└─────┬──────┴────────┬───────────────────────────────────────────┘
      │               │
      │ (完全形)      │ (誘導形)
      ▼               ▼
┌──────────┐    ┌──────────────────────────────────────────────────┐
│  5a. パラメータ抽出│  5b. 穴埋め質問フロー                        │
│  - 正規表現で分割 │  - Quick Reply: タイトル入力→日時→場所→確定 │
└──────┬───┘    └────────┬─────────────────────────────────────────┘
       │                 │
       │                 │ (ユーザー入力完了後)
       ▼                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. Code: パラメータ検証＆整形                                    │
│     - タイトル: 全角12字以内                                     │
│     - 日時: YYYY/MM/DD HH:mm形式                                │
│     - 場所: 簡潔表記                                            │
│     - サブタイトル: 1行                                         │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. HTTP Request: LLM短文化 (OpenAI API)                        │
│     - Model: gpt-4o-mini                                        │
│     - Prompt: 「以下の文章を告知カード用に短く整形」            │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. Code: SVGテンプレート組み立て                                │
│     - 雛形SVGに変数バインディング                               │
│     - カラー・フォント調整                                      │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  9. HTTP Request: SVG→PNG変換 (Puppeteer API or n8n built-in)  │
│     - SVGをPNG画像化                                            │
│     - サイズ: 1200x630px                                        │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  10. HTTP Request: Supabase Storage (画像アップロード)           │
│     - Bucket: kyoen-cards                                       │
│     - Filename: {event_id}_{timestamp}.png                      │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  11. HTTP Request: Supabase (カード履歴保存)                     │
│     - kyoen_cards テーブルへINSERT                              │
│     - image_url, title, subtitle, etc.                          │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  12. Code: Flex Message生成 (画像プレビュー)                     │
│     - 画像URLを含むFlex Message                                 │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  13. HTTP Request: LINE Push API                                │
│     - 画像カードを送信                                          │
│     - Quick Reply: 「X投稿」「IG投稿」「保存のみ」             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 共通ノード: KYOEN_Push_Retry（再送キュー）

### 目的
Push失敗時の再送処理

### ノード構成

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Schedule Trigger                                            │
│     - Cron: */5 * * * * (5分ごと)                              │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. HTTP Request: Supabase (再送キュー取得)                      │
│     - kyoen_push_retry テーブル                                 │
│     - Query: ?status=eq.pending&retry_count=lt.3               │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. If: キュー存在チェック                                       │
└────────────┬────────────────────────────────────────────────────┘
             │ (true)
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. Split Out (キュー分割)                                       │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. HTTP Request: LINE Push API (再送)                          │
└────────────┬────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. If: Push成功チェック                                         │
└────┬───────┴──────────┬──────────────────────────────────────────┘
     │                  │
(success)           (failure)
     │                  │
     ▼                  ▼
┌──────────┐      ┌────────────────────────────────────────────────┐
│ 7a. Supabase│  │ 7b. Supabase (retry_count +1)                  │
│ (status=sent)│  │ - retry_count < 3 → status=pending            │
└──────────┘      │ - retry_count >= 3 → status=failed            │
                  └────────────────────────────────────────────────┘
```

---

## 実装優先順位

1. **KYOEN_RSVP_Collector** (優先度: 高)
   - 最もシンプル
   - 既存Event DetectとRSVP Flowの橋渡し

2. **KYOEN_Reminders** (優先度: 中)
   - 3つのトリガーを段階実装
   - B-1 前日 → B-2 当日 → B-3 終了後

3. **KYOEN_Cards** (優先度: 低)
   - SVG/PNG変換が技術的チャレンジ
   - まずはLLM要約のみでも価値あり

4. **KYOEN_Push_Retry** (優先度: 中)
   - 各ワークフローの安定性向上
   - RSVP Collector実装後に着手
